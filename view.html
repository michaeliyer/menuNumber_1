<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>View Menu</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&family=Open+Sans:wght@400;500&family=Lato:wght@400;500&family=Montserrat:wght@400;500&family=Poppins:wght@400;500&family=Raleway:wght@400;500&family=Nunito:wght@400;500&family=Oswald:wght@400;500&family=Merriweather:wght@400;500&family=Quicksand:wght@400;500&family=Playfair+Display:wght@400;600;700&family=Dancing+Script:wght@400;500&family=Pacifico:wght@400&family=Indie+Flower:wght@400&family=Bangers:wght@400&family=Anton:wght@400&family=Concert+One:wght@400&family=Cinzel:wght@400;500&family=Fredoka:wght@400;500&family=Caveat:wght@400;500&family=Carter+One:wght@400&family=Courgette:wght@400&family=Julius+Sans+One:wght@400&family=Matemasie:wght@400&family=Kalam:wght@400&family=Lobster:wght@400&family=Lora:wght@400;500&family=Merriweather+Sans:wght@400;500&family=Oxygen:wght@400;500&family=PT+Sans:wght@400;500&family=Bungee+Shade:wght@400&family=Silkscreen:wght@400&family=Righteous:wght@400&family=Shadows+Into+Light:wght@400&family=Satisfy:wght@400&family=Rock+Salt:wght@400&family=Spicy+Rice:wght@400&family=Alfa+Slab+One:wght@400&family=Cormorant:wght@400;500&family=Ga+Maamli:wght@400&family=Luckiest+Guy:wght@400&family=Protest+Riot:wght@400&family=Big+Shoulders+Stencil:wght@400&family=Akaya+Kanadaka:wght@400&family=Passion+One:wght@400&family=Rubik+Mono+One:wght@400&family=Salsa:wght@400&family=Sixtyfour:wght@400&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style/base.css" />
    <link rel="stylesheet" href="style/layout.css" />
    <link rel="stylesheet" href="style/menu.css" />
    <link rel="stylesheet" href="style/print.css" media="print" />
    <style>
      .settings-panel {
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        max-width: 300px;
        max-height: calc(100vh - 4rem);
        overflow-y: auto;
        display: none;
      }

      .settings-panel::-webkit-scrollbar {
        width: 8px;
      }

      .settings-panel::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .settings-panel::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }

      .settings-panel::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      .settings-panel h3 {
        margin: 0 0 1rem;
        color: #2c3e50;
        font-size: 1.2rem;
      }

      .collapsible-section {
        margin-bottom: 1rem;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        overflow: hidden;
      }

      .section-header {
        background: #f8f9fa;
        padding: 0.75rem 1rem;
        cursor: pointer;
        user-select: none;
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.95rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s ease;
      }

      .section-header:hover {
        background: #e9ecef;
      }

      .section-header .toggle-icon {
        font-size: 0.8rem;
        transition: transform 0.2s ease;
      }

      .section-header.active .toggle-icon {
        transform: rotate(180deg);
      }

      .section-content {
        padding: 1rem;
        display: none;
        border-top: 1px solid #e0e0e0;
        background: white;
      }

      .section-content.active {
        display: block;
      }

      .settings-group {
        margin-bottom: 1rem;
      }

      .settings-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #34495e;
        font-size: 0.9rem;
      }

      .settings-group select,
      .settings-group input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
      }

      .settings-group input[type="color"] {
        height: 40px;
        padding: 2px;
      }

      .print-button {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        padding: 1rem 2rem;
        background-color: #e74c3c;
        color: white;
        border: none;
        border-radius: 4px;
        font-family: "Playfair Display", serif;
        font-size: 1rem;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: all 0.2s ease;
        display: none; /* Hidden by default, shown through hamburger menu */
      }

      .print-button:hover {
        background-color: #c0392b;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .toggle-settings {
        position: fixed;
        top: 1rem;
        right: 1rem;
        padding: 0.5rem 1rem;
        background-color: #2c3e50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        z-index: 1001;
        display: none; /* Hidden by default, shown through hamburger menu */
      }

      /* Hamburger Menu Styles */
      .hamburger-menu {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1001;
      }

      .hamburger-button {
        background: transparent;
        border: none;
        width: 50px;
        height: 50px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 4px;
        transition: all 0.3s ease;
        box-shadow: none;
      }

      .hamburger-button:hover {
        background: rgba(0, 0, 0, 0.05);
        transform: scale(1.05);
      }

      .hamburger-line {
        width: 24px;
        height: 3px;
        background: #666;
        border-radius: 2px;
        transition: all 0.3s ease;
      }

      .hamburger-button.active .hamburger-line:nth-child(1) {
        transform: rotate(45deg) translate(6px, 6px);
      }

      .hamburger-button.active .hamburger-line:nth-child(2) {
        opacity: 0;
      }

      .hamburger-button.active .hamburger-line:nth-child(3) {
        transform: rotate(-45deg) translate(6px, -6px);
      }

      .hamburger-dropdown {
        position: absolute;
        top: 60px;
        right: 0;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
        min-width: 180px;
        overflow: hidden;
      }

      .hamburger-dropdown.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .hamburger-item {
        display: flex;
        align-items: center;
        padding: 16px 20px;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
        transition: background-color 0.2s ease;
        font-size: 16px;
        color: #1a1a1a;
        text-decoration: none;
        font-weight: 500;
      }

      .hamburger-item:hover {
        background-color: #f8f9fa;
      }

      .hamburger-item:not(:last-child) {
        border-bottom: 1px solid #e9ecef;
      }

      .hamburger-icon {
        margin-right: 12px;
        width: 18px;
        text-align: center;
        font-size: 16px;
      }

      /* Voice/Audio Accessibility Styles */
      .audio-enabled {
        cursor: pointer;
        position: relative;
        transition: all 0.2s ease;
      }

      .audio-enabled:hover {
        background-color: rgba(52, 152, 219, 0.1);
        transform: scale(1.02);
      }

      .audio-enabled:active {
        transform: scale(0.98);
      }

      .speaking {
        background-color: rgba(52, 152, 219, 0.2) !important;
        animation: pulse-speaking 1.5s ease-in-out infinite;
      }

      @keyframes pulse-speaking {
        0%,
        100% {
          background-color: rgba(52, 152, 219, 0.2);
        }
        50% {
          background-color: rgba(52, 152, 219, 0.35);
        }
      }

      .audio-icon {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 20px;
        height: 20px;
        background: rgba(52, 152, 219, 0.8);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: white;
        opacity: 0;
        transition: opacity 0.2s ease;
        pointer-events: none;
      }

      .audio-enabled:hover .audio-icon {
        opacity: 1;
      }

      .voice-controls {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        display: none;
        min-width: 250px;
      }

      .voice-controls.show {
        display: block;
      }

      .voice-controls h4 {
        margin: 0 0 10px 0;
        color: #2c3e50;
        font-size: 14px;
      }

      .voice-control-group {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .voice-control-group label {
        font-size: 12px;
        color: #666;
        min-width: 60px;
      }

      .voice-control-group select,
      .voice-control-group input {
        flex: 1;
        padding: 4px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 12px;
      }

      .voice-toggle {
        background: #27ae60;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: background-color 0.2s ease;
      }

      .voice-toggle:hover {
        background: #219a52;
      }

      .voice-toggle.disabled {
        background: #95a5a6;
      }

      /* Authentication feedback styles */
      .hamburger-button.authenticated {
        opacity: 0.9;
      }

      .hamburger-button.locked {
        opacity: 0.6;
      }

      .hamburger-button.success-feedback {
        background: rgba(39, 174, 96, 0.15) !important;
        transform: scale(1.02);
      }

      .hamburger-button.error-feedback {
        background: rgba(231, 76, 60, 0.15) !important;
        animation: shake 0.3s ease-in-out;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-2px);
        }
        75% {
          transform: translateX(2px);
        }
      }

      /* Subtle indicator for authenticated state */
      .hamburger-button::after {
        content: "";
        position: absolute;
        top: 2px;
        right: 2px;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: transparent;
        transition: all 0.3s ease;
      }

      .hamburger-button.authenticated::after {
        background: #27ae60;
        box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.2);
      }

      @media print {
        .settings-panel,
        .print-button,
        .toggle-settings,
        .hamburger-menu {
          display: none;
        }
      }

      .export-info h4 {
        margin: 0 0 0.5rem;
        color: #2c3e50;
      }

      /* Separate card background and content opacity */
      .menu-card {
        position: relative;
        background: transparent !important; /* Remove default background */
      }

      .menu-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--card-background-color, #ffffff);
        border-radius: inherit;
        z-index: -1;
        /* Background opacity will be applied here */
        opacity: var(--card-bg-opacity, 1);
        filter: var(--card-bg-filter, none);
      }

      .menu-card-content {
        position: relative;
        z-index: 1;
        /* Font opacity will be applied to content elements */
      }

      /* Background overlay system for independent brightness control */
      .background-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1000;
        pointer-events: none;
        background-size: inherit;
        background-repeat: inherit;
        background-position: inherit;
        background-attachment: fixed;
      }

      /* Ensure body background is transparent when using overlay */
      body.has-background-overlay {
        background: none !important;
      }

      @media print {
        .background-overlay {
          position: absolute !important;
          top: 0 !important;
          left: 0 !important;
          width: 100% !important;
          height: 100% !important;
          z-index: -1000 !important;
          pointer-events: none !important;
          background-attachment: scroll !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
          color-adjust: exact !important;
        }
      }
    </style>
  </head>
  <body>
    <!-- Hamburger Menu -->
    <div class="hamburger-menu">
      <button class="hamburger-button" onclick="toggleHamburgerMenu()">
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
      </button>
      <div id="hamburgerDropdown" class="hamburger-dropdown">
        <!-- Menu items will be populated dynamically after authentication -->
      </div>
    </div>

    <!-- Keep original buttons hidden for fallback -->
    <button class="toggle-settings" onclick="toggleSettings()">
      ⚙️ Settings
    </button>

    <div id="settingsPanel" class="settings-panel">
      <h3>Menu Settings</h3>

      <!-- General Settings Section -->
      <div class="collapsible-section">
        <div class="section-header" onclick="toggleSection('general')">
          <span>General Settings</span>
          <span class="toggle-icon">▼</span>
        </div>
        <div id="general" class="section-content active">
          <div class="settings-group">
            <label for="fontFamily">Font Family</label>
            <select id="fontFamily" onchange="updateStyle()">
              <option value="'Roboto', sans-serif">Roboto</option>
              <option value="'Open Sans', sans-serif">Open Sans</option>
              <option value="'Lato', sans-serif">Lato</option>
              <option value="'Montserrat', sans-serif">Montserrat</option>
              <option value="'Poppins', sans-serif">Poppins</option>
              <option value="'Raleway', sans-serif">Raleway</option>
              <option value="'Nunito', sans-serif">Nunito</option>
              <option value="'Oswald', sans-serif">Oswald</option>
              <option value="'Merriweather', serif">Merriweather</option>
              <option value="'Quicksand', sans-serif">Quicksand</option>
              <option value="'Playfair Display', serif">
                Playfair Display
              </option>
              <option value="'Dancing Script', cursive">Dancing Script</option>
              <option value="'Pacifico', cursive">Pacifico</option>
              <option value="'Indie Flower', cursive">Indie Flower</option>
              <option value="'Bangers', cursive">Bangers</option>
              <option value="'Anton', sans-serif">Anton</option>
              <option value="'Concert One', cursive">Concert One</option>
              <option value="'Cinzel', serif">Cinzel</option>
              <option value="'Fredoka', sans-serif">Fredoka</option>
              <option value="'Caveat', cursive">Caveat</option>
              <option value="'Carter One', cursive">Carter One</option>
              <option value="'Courgette', cursive">Courgette</option>
              <option value="'Julius Sans One', sans-serif">
                Julius Sans One
              </option>
              <option value="'Matemasie', cursive">Matemasie</option>
              <option value="'Kalam', cursive">Kalam</option>
              <option value="'Lobster', cursive">Lobster</option>
              <option value="'Lora', serif">Lora</option>
              <option value="'Merriweather Sans', sans-serif">
                Merriweather Sans
              </option>
              <option value="'Oxygen', sans-serif">Oxygen</option>
              <option value="'PT Sans', sans-serif">PT Sans</option>
              <option value="'Bungee Shade', cursive">Bungee Shade</option>
              <option value="'Silkscreen', cursive">Silkscreen</option>
              <option value="'Righteous', cursive">Righteous</option>
              <option value="'Shadows Into Light', cursive">
                Shadows Into Light
              </option>
              <option value="'Satisfy', cursive">Satisfy</option>
              <option value="'Rock Salt', cursive">Rock Salt</option>
              <option value="'Spicy Rice', cursive">Spicy Rice</option>
              <option value="'Alfa Slab One', cursive">Alfa Slab One</option>
              <option value="'Cormorant', serif">Cormorant</option>
              <option value="'Ga Maamli', cursive">Ga Maamli</option>
              <option value="'Luckiest Guy', cursive">Luckiest Guy</option>
              <option value="'Protest Riot', sans-serif">Protest Riot</option>
              <option value="'Big Shoulders Stencil', cursive">
                Big Shoulders Stencil
              </option>
              <option value="'Akaya Kanadaka', cursive">Akaya Kanadaka</option>
              <option value="'Passion One', cursive">Passion One</option>
              <option value="'Rubik Mono One', sans-serif">
                Rubik Mono One
              </option>
              <option value="'Salsa', cursive">Salsa</option>
              <option value="'Sixtyfour', monospace">Sixtyfour</option>
            </select>
          </div>
          <div class="settings-group">
            <label for="backgroundType">Background Type</label>
            <select id="backgroundType" onchange="updateBackgroundOptions()">
              <option value="color">Solid Color</option>
              <option value="pattern">Pattern</option>
              <option value="image">Preset Image</option>
              <option value="custom">Custom Image Upload</option>
            </select>
          </div>
          <div id="colorOption" class="settings-group">
            <label for="backgroundColor">Background Color</label>
            <input type="color" id="backgroundColor" onchange="updateStyle()" />
          </div>
          <div
            id="colorBrightnessOption"
            class="settings-group"
            style="display: none"
          >
            <label for="colorBrightness"
              >Color Brightness:
              <span id="colorBrightnessValue">100%</span></label
            >
            <input
              type="range"
              id="colorBrightness"
              min="0"
              max="300"
              step="5"
              value="100"
              onchange="updateBrightnessDisplay('color'); updateStyle()"
              oninput="updateBrightnessDisplay('color')"
            />
            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem">
              0% (Black) → 100% (Normal) → 300% (Super Bright)
            </div>
          </div>
          <div id="patternOption" class="settings-group" style="display: none">
            <label for="backgroundPattern">Pattern</label>
            <select id="backgroundPattern" onchange="updateStyle()">
              <option value="wood-pattern.svg">Wood Pattern</option>
              <option value="marble-pattern.svg">Marble Pattern</option>
              <option value="subtle-pattern.svg">Subtle Pattern</option>
            </select>
          </div>
          <div
            id="patternBrightnessOption"
            class="settings-group"
            style="display: none"
          >
            <label for="patternBrightness"
              >Pattern Brightness:
              <span id="patternBrightnessValue">100%</span></label
            >
            <input
              type="range"
              id="patternBrightness"
              min="0"
              max="300"
              step="5"
              value="100"
              onchange="updateBrightnessDisplay('pattern'); updateStyle()"
              oninput="updateBrightnessDisplay('pattern')"
            />
            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem">
              Adjust pattern brightness and contrast
            </div>
          </div>
          <div id="imageOption" class="settings-group" style="display: none">
            <label for="backgroundImage">Image</label>
            <select id="backgroundImage" onchange="updateStyle()">
              <option value="flickImageOne.jpg">Flick Image One</option>
              <option value="flickImageTwo.jpg">Flick Image Two</option>
              <option value="flickImageThree.jpg">Flick Image Three</option>
              <option value="flickImageFour.jpg">Flick Image Four</option>
              <option value="flickImageFive.jpg">Flick Image Five</option>
              <option value="flickImageSix.jpg">Flick Image Six</option>
              <option value="flickImageSeven.jpg">Flick Image Seven</option>
              <option value="flick1111.jpg">Flick Image 1111</option>
            </select>
          </div>
          <div
            id="imageBrightnessOption"
            class="settings-group"
            style="display: none"
          >
            <label for="imageBrightness"
              >Image Brightness:
              <span id="imageBrightnessValue">100%</span></label
            >
            <input
              type="range"
              id="imageBrightness"
              min="0"
              max="300"
              step="5"
              value="100"
              onchange="updateBrightnessDisplay('image'); updateStyle()"
              oninput="updateBrightnessDisplay('image')"
            />
            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem">
              Perfect for mood lighting and contrast adjustment
            </div>
          </div>
          <div
            id="customImageOption"
            class="settings-group"
            style="display: none"
          >
            <label for="customBackgroundUpload">Upload Custom Background</label>
            <input
              type="file"
              id="customBackgroundUpload"
              accept="image/*"
              onchange="handleCustomBackground(event)"
              style="
                width: 100%;
                padding: 0.5rem;
                border: 1px solid #ddd;
                border-radius: 4px;
              "
            />
            <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666">
              📱 iOS: Tap to select from Photos, Camera, or Files<br />
              💻 Desktop: Choose any JPG, PNG, GIF, or WebP image
            </div>
          </div>
          <div
            id="customImageBrightnessOption"
            class="settings-group"
            style="display: none"
          >
            <label for="customImageBrightness"
              >Custom Image Brightness:
              <span id="customImageBrightnessValue">100%</span></label
            >
            <input
              type="range"
              id="customImageBrightness"
              min="0"
              max="300"
              step="5"
              value="100"
              onchange="updateBrightnessDisplay('customImage'); updateStyle()"
              oninput="updateBrightnessDisplay('customImage')"
            />
            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem">
              Fine-tune your uploaded image's brightness
            </div>
          </div>
        </div>
      </div>

      <!-- Main Header Section -->
      <div class="collapsible-section">
        <div class="section-header" onclick="toggleSection('mainHeader')">
          <span>Main Menu Header</span>
          <span class="toggle-icon">▼</span>
        </div>
        <div id="mainHeader" class="section-content">
          <div class="settings-group">
            <label for="mainHeaderFont">Font Family</label>
            <select id="mainHeaderFont" onchange="updateStyle()">
              <option value="'Playfair Display', serif">
                Playfair Display
              </option>
              <option value="'Dancing Script', cursive">Dancing Script</option>
              <option value="'Pacifico', cursive">Pacifico</option>
              <option value="'Bangers', cursive">Bangers</option>
              <option value="'Anton', sans-serif">Anton</option>
              <option value="'Concert One', cursive">Concert One</option>
              <option value="'Cinzel', serif">Cinzel</option>
              <option value="'Fredoka', sans-serif">Fredoka</option>
              <option value="'Caveat', cursive">Caveat</option>
              <option value="'Carter One', cursive">Carter One</option>
              <option value="'Courgette', cursive">Courgette</option>
              <option value="'Julius Sans One', sans-serif">
                Julius Sans One
              </option>
              <option value="'Matemasie', cursive">Matemasie</option>
              <option value="'Kalam', cursive">Kalam</option>
              <option value="'Lobster', cursive">Lobster</option>
              <option value="'Lora', serif">Lora</option>
              <option value="'Merriweather Sans', sans-serif">
                Merriweather Sans
              </option>
              <option value="'Oxygen', sans-serif">Oxygen</option>
              <option value="'PT Sans', sans-serif">PT Sans</option>
              <option value="'Bungee Shade', cursive">Bungee Shade</option>
              <option value="'Silkscreen', cursive">Silkscreen</option>
              <option value="'Righteous', cursive">Righteous</option>
              <option value="'Shadows Into Light', cursive">
                Shadows Into Light
              </option>
              <option value="'Satisfy', cursive">Satisfy</option>
              <option value="'Rock Salt', cursive">Rock Salt</option>
              <option value="'Spicy Rice', cursive">Spicy Rice</option>
              <option value="'Alfa Slab One', cursive">Alfa Slab One</option>
              <option value="'Cormorant', serif">Cormorant</option>
              <option value="'Ga Maamli', cursive">Ga Maamli</option>
              <option value="'Luckiest Guy', cursive">Luckiest Guy</option>
              <option value="'Protest Riot', sans-serif">Protest Riot</option>
              <option value="'Big Shoulders Stencil', cursive">
                Big Shoulders Stencil
              </option>
              <option value="'Akaya Kanadaka', cursive">Akaya Kanadaka</option>
              <option value="'Passion One', cursive">Passion One</option>
              <option value="'Rubik Mono One', sans-serif">
                Rubik Mono One
              </option>
              <option value="'Salsa', cursive">Salsa</option>
              <option value="'Sixtyfour', monospace">Sixtyfour</option>
            </select>
          </div>
          <div class="settings-group">
            <label for="mainHeaderColor">Header Color</label>
            <input
              type="color"
              id="mainHeaderColor"
              value="#2c3e50"
              onchange="updateStyle()"
            />
          </div>
          <div class="settings-group">
            <label for="mainHeaderBackground">Background Color</label>
            <input
              type="color"
              id="mainHeaderBackground"
              value="#ffffff"
              onchange="updateStyle()"
            />
          </div>
          <div class="settings-group">
            <label for="mainHeaderSize">Header Size (px)</label>
            <input
              type="number"
              id="mainHeaderSize"
              value="36"
              min="16"
              max="96"
              step="1"
              onchange="updateStyle()"
            />
          </div>
          <div class="settings-group">
            <label for="mainHeaderWeight">Header Font Weight</label>
            <select id="mainHeaderWeight" onchange="updateStyle()">
              <option value="400">Normal (400)</option>
              <option value="500">Medium (500)</option>
              <option value="600">Semi-Bold (600)</option>
              <option value="700" selected>Bold (700)</option>
              <option value="800">Extra Bold (800)</option>
              <option value="900">Black (900)</option>
            </select>
          </div>
          <div class="settings-group">
            <label for="dateSize">Date Size (px)</label>
            <input
              type="number"
              id="dateSize"
              value="16"
              min="10"
              max="48"
              step="1"
              onchange="updateStyle()"
            />
          </div>
          <div class="settings-group">
            <label for="mainHeaderOpacity"
              >Header Opacity:
              <span id="mainHeaderOpacityValue">100%</span></label
            >
            <input
              type="range"
              id="mainHeaderOpacity"
              min="0"
              max="1000"
              step="5"
              value="100"
              onchange="updateOpacityDisplay('mainHeader'); updateStyle()"
              oninput="updateOpacityDisplay('mainHeader')"
            />
            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem">
              Controls entire header section transparency
            </div>
          </div>
        </div>
      </div>

      <!-- Section Headers Section -->
      <div class="collapsible-section">
        <div class="section-header" onclick="toggleSection('sectionHeaders')">
          <span>Section Headers</span>
          <span class="toggle-icon">▼</span>
        </div>
        <div id="sectionHeaders" class="section-content">
          <div class="settings-group">
            <label for="sectionHeaderFont">Font Family</label>
            <select id="sectionHeaderFont" onchange="updateStyle()">
              <option value="'Playfair Display', serif">
                Playfair Display
              </option>
              <option value="'Dancing Script', cursive">Dancing Script</option>
              <option value="'Pacifico', cursive">Pacifico</option>
              <option value="'Bangers', cursive">Bangers</option>
              <option value="'Anton', sans-serif">Anton</option>
              <option value="'Concert One', cursive">Concert One</option>
              <option value="'Cinzel', serif">Cinzel</option>
              <option value="'Fredoka', sans-serif">Fredoka</option>
              <option value="'Caveat', cursive">Caveat</option>
              <option value="'Carter One', cursive">Carter One</option>
              <option value="'Courgette', cursive">Courgette</option>
              <option value="'Julius Sans One', sans-serif">
                Julius Sans One
              </option>
              <option value="'Matemasie', cursive">Matemasie</option>
              <option value="'Kalam', cursive">Kalam</option>
              <option value="'Lobster', cursive">Lobster</option>
              <option value="'Lora', serif">Lora</option>
              <option value="'Merriweather Sans', sans-serif">
                Merriweather Sans
              </option>
              <option value="'Oxygen', sans-serif">Oxygen</option>
              <option value="'PT Sans', sans-serif">PT Sans</option>
              <option value="'Bungee Shade', cursive">Bungee Shade</option>
              <option value="'Silkscreen', cursive">Silkscreen</option>
              <option value="'Righteous', cursive">Righteous</option>
              <option value="'Shadows Into Light', cursive">
                Shadows Into Light
              </option>
              <option value="'Satisfy', cursive">Satisfy</option>
              <option value="'Rock Salt', cursive">Rock Salt</option>
              <option value="'Spicy Rice', cursive">Spicy Rice</option>
              <option value="'Alfa Slab One', cursive">Alfa Slab One</option>
              <option value="'Cormorant', serif">Cormorant</option>
              <option value="'Ga Maamli', cursive">Ga Maamli</option>
              <option value="'Luckiest Guy', cursive">Luckiest Guy</option>
              <option value="'Protest Riot', sans-serif">Protest Riot</option>
              <option value="'Big Shoulders Stencil', cursive">
                Big Shoulders Stencil
              </option>
              <option value="'Akaya Kanadaka', cursive">Akaya Kanadaka</option>
              <option value="'Passion One', cursive">Passion One</option>
              <option value="'Rubik Mono One', sans-serif">
                Rubik Mono One
              </option>
              <option value="'Salsa', cursive">Salsa</option>
              <option value="'Sixtyfour', monospace">Sixtyfour</option>
            </select>
          </div>
          <div class="settings-group">
            <label for="headerColor">Header Color</label>
            <input
              type="color"
              id="headerColor"
              value="#2c3e50"
              onchange="updateStyle()"
            />
          </div>
          <div class="settings-group">
            <label for="headerSize">Header Size (px)</label>
            <input
              type="number"
              id="headerSize"
              value="28"
              min="14"
              max="72"
              step="1"
              onchange="updateStyle()"
            />
          </div>
          <div class="settings-group">
            <label for="sectionHeaderWeight">Section Header Font Weight</label>
            <select id="sectionHeaderWeight" onchange="updateStyle()">
              <option value="400">Normal (400)</option>
              <option value="500">Medium (500)</option>
              <option value="600" selected>Semi-Bold (600)</option>
              <option value="700">Bold (700)</option>
              <option value="800">Extra Bold (800)</option>
            </select>
          </div>
          <div class="settings-group">
            <label for="sectionHeaderOpacity"
              >Section Header Opacity:
              <span id="sectionHeaderOpacityValue">100%</span></label
            >
            <input
              type="range"
              id="sectionHeaderOpacity"
              min="0"
              max="1000"
              step="5"
              value="100"
              onchange="updateOpacityDisplay('sectionHeader'); updateStyle()"
              oninput="updateOpacityDisplay('sectionHeader')"
            />
            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem">
              Controls section title transparency
            </div>
          </div>
        </div>
      </div>

      <!-- Menu Cards Section -->
      <div class="collapsible-section">
        <div class="section-header" onclick="toggleSection('menuCards')">
          <span>Menu Cards</span>
          <span class="toggle-icon">▼</span>
        </div>
        <div id="menuCards" class="section-content">
          <div class="settings-group">
            <label for="cardFont">Font Family</label>
            <select id="cardFont" onchange="updateStyle()">
              <option value="'Roboto', sans-serif">Roboto</option>
              <option value="'Open Sans', sans-serif">Open Sans</option>
              <option value="'Lato', sans-serif">Lato</option>
              <option value="'Montserrat', sans-serif">Montserrat</option>
              <option value="'Poppins', sans-serif">Poppins</option>
              <option value="'Raleway', sans-serif">Raleway</option>
              <option value="'Nunito', sans-serif">Nunito</option>
              <option value="'Oswald', sans-serif">Oswald</option>
              <option value="'Merriweather', serif">Merriweather</option>
              <option value="'Quicksand', sans-serif">Quicksand</option>
              <option value="'Playfair Display', serif">
                Playfair Display
              </option>
              <option value="'Dancing Script', cursive">Dancing Script</option>
              <option value="'Pacifico', cursive">Pacifico</option>
              <option value="'Indie Flower', cursive">Indie Flower</option>
              <option value="'Bangers', cursive">Bangers</option>
              <option value="'Anton', sans-serif">Anton</option>
              <option value="'Concert One', cursive">Concert One</option>
              <option value="'Cinzel', serif">Cinzel</option>
              <option value="'Fredoka', sans-serif">Fredoka</option>
              <option value="'Caveat', cursive">Caveat</option>
              <option value="'Carter One', cursive">Carter One</option>
              <option value="'Courgette', cursive">Courgette</option>
              <option value="'Julius Sans One', sans-serif">
                Julius Sans One
              </option>
              <option value="'Matemasie', cursive">Matemasie</option>
              <option value="'Kalam', cursive">Kalam</option>
              <option value="'Lobster', cursive">Lobster</option>
              <option value="'Lora', serif">Lora</option>
              <option value="'Merriweather Sans', sans-serif">
                Merriweather Sans
              </option>
              <option value="'Oxygen', sans-serif">Oxygen</option>
              <option value="'PT Sans', sans-serif">PT Sans</option>
              <option value="'Bungee Shade', cursive">Bungee Shade</option>
              <option value="'Silkscreen', cursive">Silkscreen</option>
              <option value="'Righteous', cursive">Righteous</option>
              <option value="'Shadows Into Light', cursive">
                Shadows Into Light
              </option>
              <option value="'Satisfy', cursive">Satisfy</option>
              <option value="'Rock Salt', cursive">Rock Salt</option>
              <option value="'Spicy Rice', cursive">Spicy Rice</option>
              <option value="'Alfa Slab One', cursive">Alfa Slab One</option>
              <option value="'Cormorant', serif">Cormorant</option>
              <option value="'Ga Maamli', cursive">Ga Maamli</option>
              <option value="'Luckiest Guy', cursive">Luckiest Guy</option>
              <option value="'Protest Riot', sans-serif">Protest Riot</option>
              <option value="'Big Shoulders Stencil', cursive">
                Big Shoulders Stencil
              </option>
              <option value="'Akaya Kanadaka', cursive">Akaya Kanadaka</option>
              <option value="'Passion One', cursive">Passion One</option>
              <option value="'Rubik Mono One', sans-serif">
                Rubik Mono One
              </option>
              <option value="'Salsa', cursive">Salsa</option>
              <option value="'Sixtyfour', monospace">Sixtyfour</option>
            </select>
          </div>
          <div class="settings-group">
            <label for="cardBackgroundColor">Background Color</label>
            <input
              type="color"
              id="cardBackgroundColor"
              value="#ffffff"
              onchange="updateStyle()"
            />
          </div>
          <div class="settings-group">
            <label for="cardOpacity"
              >Card Background Opacity:
              <span id="cardOpacityValue">100%</span></label
            >
            <input
              type="range"
              id="cardOpacity"
              min="0"
              max="1000"
              step="5"
              value="100"
              onchange="updateOpacityDisplay('card'); updateStyle()"
              oninput="updateOpacityDisplay('card')"
            />
            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem">
              0% (Invisible) → 100% (Normal) → 1000% (Super Bright)
            </div>
          </div>
          <div class="settings-group">
            <label for="cardFontOpacity"
              >Card Font Opacity:
              <span id="cardFontOpacityValue">100%</span></label
            >
            <input
              type="range"
              id="cardFontOpacity"
              min="0"
              max="1000"
              step="5"
              value="100"
              onchange="updateOpacityDisplay('cardFont'); updateStyle()"
              oninput="updateOpacityDisplay('cardFont')"
            />
            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem">
              Separate opacity control for text inside cards
            </div>
          </div>
          <div class="settings-group">
            <label for="cardTextColor">Text Color</label>
            <input
              type="color"
              id="cardTextColor"
              value="#34495e"
              onchange="updateStyle()"
            />
          </div>
          <div class="settings-group">
            <label for="cardFontWeight">Card Font Weight</label>
            <select id="cardFontWeight" onchange="updateStyle()">
              <option value="300">Light (300)</option>
              <option value="400" selected>Normal (400)</option>
              <option value="500">Medium (500)</option>
              <option value="600">Semi-Bold (600)</option>
              <option value="700">Bold (700)</option>
            </select>
          </div>
          <div class="settings-group">
            <label for="cardTextSize">Text Size (px)</label>
            <input
              type="number"
              id="cardTextSize"
              value="16"
              min="8"
              max="48"
              step="1"
              onchange="updateStyle()"
            />
          </div>
          <div class="settings-group">
            <label for="cardTitleSize">Title Size (px)</label>
            <input
              type="number"
              id="cardTitleSize"
              value="20"
              min="10"
              max="64"
              step="1"
              onchange="updateStyle()"
            />
          </div>
          <div class="settings-group">
            <label for="cardTitleWeight">Title Font Weight</label>
            <select id="cardTitleWeight" onchange="updateStyle()">
              <option value="400">Normal (400)</option>
              <option value="500">Medium (500)</option>
              <option value="600" selected>Semi-Bold (600)</option>
              <option value="700">Bold (700)</option>
              <option value="800">Extra Bold (800)</option>
            </select>
          </div>
          <div class="settings-group">
            <label for="priceColor">Price Color</label>
            <input
              type="color"
              id="priceColor"
              value="#e74c3c"
              onchange="updateStyle()"
            />
          </div>
          <div class="settings-group">
            <label for="priceSize">Price Size (px)</label>
            <input
              type="number"
              id="priceSize"
              value="16"
              min="8"
              max="48"
              step="1"
              onchange="updateStyle()"
            />
          </div>
          <div class="settings-group">
            <label for="priceFontWeight">Price Font Weight</label>
            <select id="priceFontWeight" onchange="updateStyle()">
              <option value="400">Normal (400)</option>
              <option value="500">Medium (500)</option>
              <option value="600" selected>Semi-Bold (600)</option>
              <option value="700">Bold (700)</option>
              <option value="800">Extra Bold (800)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Borders & Outlines Section -->
      <div class="collapsible-section">
        <div class="section-header" onclick="toggleSection('borders')">
          <span>Borders & Outlines</span>
          <span class="toggle-icon">▼</span>
        </div>
        <div id="borders" class="section-content">
          <div class="settings-group">
            <label for="cardBorderColor">Card Border Color</label>
            <input
              type="color"
              id="cardBorderColor"
              value="#e0e0e0"
              onchange="updateStyle()"
            />
          </div>
          <div class="settings-group">
            <label for="cardBorderWidth">Card Border Width (px)</label>
            <input
              type="number"
              id="cardBorderWidth"
              value="1"
              min="0"
              max="10"
              step="1"
              onchange="updateStyle()"
            />
          </div>
          <div class="settings-group">
            <label for="cardBorderStyle">Card Border Style</label>
            <select id="cardBorderStyle" onchange="updateStyle()">
              <option value="solid">Solid</option>
              <option value="dashed">Dashed</option>
              <option value="dotted">Dotted</option>
              <option value="double">Double</option>
              <option value="groove">Groove</option>
              <option value="ridge">Ridge</option>
              <option value="inset">Inset</option>
              <option value="outset">Outset</option>
              <option value="none">None</option>
            </select>
          </div>
          <div class="settings-group">
            <label for="cardBorderOpacity"
              >Card Border Opacity:
              <span id="cardBorderOpacityValue">100%</span></label
            >
            <input
              type="range"
              id="cardBorderOpacity"
              min="0"
              max="100"
              step="1"
              value="100"
              onchange="updateBorderOpacityDisplay('cardBorder'); updateStyle()"
              oninput="updateBorderOpacityDisplay('cardBorder')"
            />
            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem">
              Controls card border transparency independently
            </div>
          </div>

          <hr
            style="margin: 1rem 0; border: none; border-top: 1px solid #eee"
          />

          <div class="settings-group">
            <label for="headerBorderColor">Section Header Border Color</label>
            <input
              type="color"
              id="headerBorderColor"
              value="#e74c3c"
              onchange="updateStyle()"
            />
          </div>
          <div class="settings-group">
            <label for="headerBorderWidth"
              >Section Header Border Width (px)</label
            >
            <input
              type="number"
              id="headerBorderWidth"
              value="2"
              min="0"
              max="10"
              step="1"
              onchange="updateStyle()"
            />
          </div>
          <div class="settings-group">
            <label for="headerBorderOpacity"
              >Section Header Border Opacity:
              <span id="headerBorderOpacityValue">100%</span></label
            >
            <input
              type="range"
              id="headerBorderOpacity"
              min="0"
              max="100"
              step="1"
              value="100"
              onchange="updateBorderOpacityDisplay('headerBorder'); updateStyle()"
              oninput="updateBorderOpacityDisplay('headerBorder')"
            />
            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem">
              Controls section title underline transparency
            </div>
          </div>

          <hr
            style="margin: 1rem 0; border: none; border-top: 1px solid #eee"
          />

          <div class="settings-group">
            <label for="mainHeaderBorderColor">Main Header Border Color</label>
            <input
              type="color"
              id="mainHeaderBorderColor"
              value="#dddddd"
              onchange="updateStyle()"
            />
          </div>
          <div class="settings-group">
            <label for="mainHeaderBorderWidth"
              >Main Header Border Width (px)</label
            >
            <input
              type="number"
              id="mainHeaderBorderWidth"
              value="1"
              min="0"
              max="10"
              step="1"
              onchange="updateStyle()"
            />
          </div>
          <div class="settings-group">
            <label for="mainHeaderBorderOpacity"
              >Main Header Border Opacity:
              <span id="mainHeaderBorderOpacityValue">100%</span></label
            >
            <input
              type="range"
              id="mainHeaderBorderOpacity"
              min="0"
              max="100"
              step="1"
              value="100"
              onchange="updateBorderOpacityDisplay('mainHeaderBorder'); updateStyle()"
              oninput="updateBorderOpacityDisplay('mainHeaderBorder')"
            />
            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem">
              Controls main title area border transparency
            </div>
          </div>

          <hr
            style="margin: 1rem 0; border: none; border-top: 1px solid #eee"
          />

          <div class="settings-group">
            <label for="sectionBorderColor"
              >Menu Section Container Border Color</label
            >
            <input
              type="color"
              id="sectionBorderColor"
              value="#e0e0e0"
              onchange="updateStyle()"
            />
          </div>
          <div class="settings-group">
            <label for="sectionBorderWidth"
              >Menu Section Container Border Width (px)</label
            >
            <input
              type="number"
              id="sectionBorderWidth"
              value="1"
              min="0"
              max="10"
              step="1"
              onchange="updateStyle()"
            />
          </div>
          <div class="settings-group">
            <label for="sectionBorderOpacity"
              >Menu Section Container Border Opacity:
              <span id="sectionBorderOpacityValue">100%</span></label
            >
            <input
              type="range"
              id="sectionBorderOpacity"
              min="0"
              max="100"
              step="1"
              value="100"
              onchange="updateBorderOpacityDisplay('sectionBorder'); updateStyle()"
              oninput="updateBorderOpacityDisplay('sectionBorder')"
            />
            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem">
              Controls outer container border transparency
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="menuContainer"></div>
    <button class="print-button" onclick="window.print()">Print Menu</button>

    <!-- Voice Controls Panel -->
    <div id="voiceControls" class="voice-controls">
      <h4>🔊 Voice Controls</h4>

      <div class="voice-control-group">
        <label>Voice:</label>
        <select id="voiceSelect"></select>
      </div>

      <div class="voice-control-group">
        <label>Speed:</label>
        <input
          type="range"
          id="speechRate"
          min="0.5"
          max="2"
          step="0.1"
          value="1"
        />
        <span id="rateDisplay">1.0x</span>
      </div>

      <div class="voice-control-group">
        <label>Pitch:</label>
        <input
          type="range"
          id="speechPitch"
          min="0.5"
          max="2"
          step="0.1"
          value="1"
        />
        <span id="pitchDisplay">1.0</span>
      </div>

      <div class="voice-control-group">
        <button
          id="voiceToggle"
          class="voice-toggle"
          onclick="toggleVoiceMode()"
        >
          Enable Voice
        </button>
        <button
          onclick="testVoice()"
          style="
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
          "
        >
          Test Voice
        </button>
      </div>

      <div
        style="
          margin-top: 10px;
          padding-top: 10px;
          border-top: 1px solid #eee;
          font-size: 11px;
          color: #666;
        "
      >
        💡 Click any menu item or header to hear it read aloud
      </div>
    </div>

    <script type="module">
      import { initDB, getMenu, saveMenu } from "./script/db.js";

      window.addEventListener("DOMContentLoaded", async () => {
        try {
          await initDB();

          const params = new URLSearchParams(window.location.search);
          const menuId = params.get("id");
          const debugMode = params.get("debug") === "true";

          if (!menuId) {
            document.getElementById("menuContainer").innerHTML =
              "<p>No menu ID specified in URL.</p>";
            return;
          }

          const menu = await getMenu(menuId);
          if (!menu) {
            document.getElementById(
              "menuContainer"
            ).innerHTML = `<p>No menu found for ID "${menuId}".</p>`;
            return;
          }

          renderMenu(menu);
          // Initialize settings from menu data
          initializeSettings(menu);
        } catch (error) {
          console.error("Error loading menu:", error);
          document.getElementById("menuContainer").innerHTML =
            "<p>Error loading menu. Please try again.</p>";
        }

        // Load access codes configuration - ensure this completes before proceeding
        await loadAccessCodes();

        // iOS debugging info
        const deviceInfo = {
          userAgent: navigator.userAgent,
          isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),
          isSafari:
            /Safari/.test(navigator.userAgent) &&
            !/Chrome/.test(navigator.userAgent),
          platform: navigator.platform,
          sessionStorageSupported: typeof Storage !== "undefined",
          fetchSupported: typeof fetch !== "undefined",
        };
        console.log("🍎 Device info:", deviceInfo);

        // Check authentication state
        if (sessionStorage.getItem("menuAuthenticated") === "true") {
          authenticated = true;
          console.log("🔓 Found existing authentication session");
        }
        updateHamburgerDisplay();

        // Initialize voice system
        initVoiceSystem();

        // Load custom audio if available
        await loadCustomAudio();

        // Debug mode for iOS troubleshooting
        if (params.get("debug") === "true") {
          console.log("🚨 DEBUG MODE ENABLED");

          // Create debug info panel
          const debugPanel = document.createElement("div");
          debugPanel.id = "debugPanel";
          debugPanel.style.cssText = `
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            z-index: 9999;
            max-width: 300px;
            max-height: 400px;
            overflow-y: auto;
          `;

          const dynamicCode = generateDynamicCode();
          const validCodes = [...ACCESS_CODES];
          if (dynamicCode) validCodes.push(dynamicCode);

          debugPanel.innerHTML = `
            <h4 style="margin: 0 0 10px 0; color: #ff6b6b;">🐛 DEBUG INFO</h4>
            <div><strong>iOS Device:</strong> ${deviceInfo.isIOS}</div>
            <div><strong>Safari:</strong> ${deviceInfo.isSafari}</div>
            <div><strong>Platform:</strong> ${deviceInfo.platform}</div>
            <div><strong>Session Storage:</strong> ${
              deviceInfo.sessionStorageSupported
            }</div>
            <div><strong>Fetch Support:</strong> ${
              deviceInfo.fetchSupported
            }</div>
            <div><strong>Auth State:</strong> ${authenticated}</div>
            <div><strong>Valid Codes:</strong><br>${validCodes.join(", ")}</div>
            <div style="margin-top: 10px;">
              <button onclick="testDebugPrompt()" style="background: #007AFF; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px;">Test Prompt</button>
              <button onclick="forceAuth()" style="background: #34c759; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px; margin-left: 5px;">Force Auth</button>
            </div>
            <div style="margin-top: 5px;">
              <button onclick="document.getElementById('debugPanel').remove()" style="background: #ff3b30; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px;">Close</button>
            </div>
          `;

          document.body.appendChild(debugPanel);

          // Debug functions
          window.testDebugPrompt = function () {
            console.log("🧪 Testing prompt in debug mode...");
            try {
              const result = prompt("DEBUG: Enter any access code:");
              console.log("📝 Debug prompt result:", result);
              if (result) {
                const isValid =
                  validCodes.includes(result) ||
                  validCodes.includes(result.toLowerCase());
                console.log(
                  `🔍 Code "${result}" is ${isValid ? "VALID" : "INVALID"}`
                );
                alert(
                  `Code "${result}" is ${
                    isValid ? "VALID ✅" : "INVALID ❌"
                  }\n\nValid codes: ${validCodes.join(", ")}`
                );
              }
            } catch (error) {
              console.error("❌ Debug prompt failed:", error);
              alert("Prompt failed: " + error.message);
            }
          };

          window.forceAuth = function () {
            authenticated = true;
            sessionStorage.setItem("menuAuthenticated", "true");
            updateHamburgerDisplay();
            console.log("🔓 Force authentication enabled");
            alert("Authentication forced on for this session");
          };
        }

        // Test function for debugging (can be called from console)
        window.testAccessCodes = function () {
          console.log("🧪 Testing access codes...");
          console.log("Available codes:", ACCESS_CODES);
          console.log("Dynamic code enabled:", DYNAMIC_CODE_ENABLED);
          console.log("Dynamic code prefix:", DYNAMIC_CODE_PREFIX);
          const dynamicCode = generateDynamicCode();
          if (dynamicCode) console.log("Today's dynamic code:", dynamicCode);
          console.log("Authentication state:", authenticated);
          console.log(
            "Session storage:",
            sessionStorage.getItem("menuAuthenticated")
          );
        };
      });

      function initializeSettings(menu) {
        if (menu.background?.startsWith("#")) {
          document.getElementById("backgroundColor").value = menu.background;
          document.getElementById("backgroundType").value = "color";
        } else if (menu.background) {
          document.getElementById("backgroundImage").value = menu.background;
          document.getElementById("backgroundType").value = "image";
        }

        // Load saved style settings
        if (menu.styleSettings) {
          const settings = menu.styleSettings;
          if (settings.fontFamily)
            document.getElementById("fontFamily").value = settings.fontFamily;
          if (settings.backgroundType) {
            document.getElementById("backgroundType").value =
              settings.backgroundType;
            updateBackgroundOptions();
          }
          if (settings.backgroundColor)
            document.getElementById("backgroundColor").value =
              settings.backgroundColor;
          if (settings.backgroundPattern)
            document.getElementById("backgroundPattern").value =
              settings.backgroundPattern;
          if (settings.backgroundImage)
            document.getElementById("backgroundImage").value =
              settings.backgroundImage;
          if (settings.mainHeaderFont)
            document.getElementById("mainHeaderFont").value =
              settings.mainHeaderFont;
          if (settings.sectionHeaderFont)
            document.getElementById("sectionHeaderFont").value =
              settings.sectionHeaderFont;
          if (settings.cardFont)
            document.getElementById("cardFont").value = settings.cardFont;
          if (settings.mainHeaderColor)
            document.getElementById("mainHeaderColor").value =
              settings.mainHeaderColor;
          if (settings.mainHeaderBackground)
            document.getElementById("mainHeaderBackground").value =
              settings.mainHeaderBackground;
          if (settings.mainHeaderSize)
            document.getElementById("mainHeaderSize").value =
              settings.mainHeaderSize;
          if (settings.dateSize)
            document.getElementById("dateSize").value = settings.dateSize;
          if (settings.headerColor)
            document.getElementById("headerColor").value = settings.headerColor;
          if (settings.headerSize)
            document.getElementById("headerSize").value = settings.headerSize;
          if (settings.cardBackgroundColor)
            document.getElementById("cardBackgroundColor").value =
              settings.cardBackgroundColor;
          if (settings.cardOpacity)
            document.getElementById("cardOpacity").value = settings.cardOpacity;
          if (settings.cardTextColor)
            document.getElementById("cardTextColor").value =
              settings.cardTextColor;
          if (settings.priceColor)
            document.getElementById("priceColor").value = settings.priceColor;
          if (settings.cardFontWeight)
            document.getElementById("cardFontWeight").value =
              settings.cardFontWeight;
          if (settings.cardTitleWeight)
            document.getElementById("cardTitleWeight").value =
              settings.cardTitleWeight;
          if (settings.priceFontWeight)
            document.getElementById("priceFontWeight").value =
              settings.priceFontWeight;
          if (settings.mainHeaderWeight)
            document.getElementById("mainHeaderWeight").value =
              settings.mainHeaderWeight;
          if (settings.sectionHeaderWeight)
            document.getElementById("sectionHeaderWeight").value =
              settings.sectionHeaderWeight;
          if (settings.cardTextSize)
            document.getElementById("cardTextSize").value =
              settings.cardTextSize;
          if (settings.cardTitleSize)
            document.getElementById("cardTitleSize").value =
              settings.cardTitleSize;
          if (settings.priceSize)
            document.getElementById("priceSize").value = settings.priceSize;
          if (settings.cardFontOpacity)
            document.getElementById("cardFontOpacity").value =
              settings.cardFontOpacity;
          if (settings.mainHeaderOpacity)
            document.getElementById("mainHeaderOpacity").value =
              settings.mainHeaderOpacity;
          if (settings.sectionHeaderOpacity)
            document.getElementById("sectionHeaderOpacity").value =
              settings.sectionHeaderOpacity;
          if (settings.customBackgroundDataURL)
            customBackgroundDataURL = settings.customBackgroundDataURL;
          // Load brightness settings
          if (settings.colorBrightness)
            document.getElementById("colorBrightness").value =
              settings.colorBrightness;
          if (settings.patternBrightness)
            document.getElementById("patternBrightness").value =
              settings.patternBrightness;
          if (settings.imageBrightness)
            document.getElementById("imageBrightness").value =
              settings.imageBrightness;
          if (settings.customImageBrightness)
            document.getElementById("customImageBrightness").value =
              settings.customImageBrightness;
          // Add border settings
          if (settings.cardBorderColor)
            document.getElementById("cardBorderColor").value =
              settings.cardBorderColor;
          if (settings.cardBorderWidth)
            document.getElementById("cardBorderWidth").value =
              settings.cardBorderWidth;
          if (settings.cardBorderStyle)
            document.getElementById("cardBorderStyle").value =
              settings.cardBorderStyle;
          if (settings.cardBorderOpacity)
            document.getElementById("cardBorderOpacity").value =
              settings.cardBorderOpacity;
          if (settings.headerBorderColor)
            document.getElementById("headerBorderColor").value =
              settings.headerBorderColor;
          if (settings.headerBorderWidth)
            document.getElementById("headerBorderWidth").value =
              settings.headerBorderWidth;
          if (settings.headerBorderOpacity)
            document.getElementById("headerBorderOpacity").value =
              settings.headerBorderOpacity;
          if (settings.mainHeaderBorderColor)
            document.getElementById("mainHeaderBorderColor").value =
              settings.mainHeaderBorderColor;
          if (settings.mainHeaderBorderWidth)
            document.getElementById("mainHeaderBorderWidth").value =
              settings.mainHeaderBorderWidth;
          if (settings.mainHeaderBorderOpacity)
            document.getElementById("mainHeaderBorderOpacity").value =
              settings.mainHeaderBorderOpacity;
          if (settings.sectionBorderColor)
            document.getElementById("sectionBorderColor").value =
              settings.sectionBorderColor;
          if (settings.sectionBorderWidth)
            document.getElementById("sectionBorderWidth").value =
              settings.sectionBorderWidth;
          if (settings.sectionBorderOpacity)
            document.getElementById("sectionBorderOpacity").value =
              settings.sectionBorderOpacity;
        }

        // Update opacity displays
        updateOpacityDisplay("mainHeader");
        updateOpacityDisplay("sectionHeader");
        updateOpacityDisplay("card");
        updateOpacityDisplay("cardFont");

        // Update brightness displays
        updateBrightnessDisplay("color");
        updateBrightnessDisplay("pattern");
        updateBrightnessDisplay("image");
        updateBrightnessDisplay("customImage");

        // Update border opacity displays
        updateBorderOpacityDisplay("cardBorder");
        updateBorderOpacityDisplay("headerBorder");
        updateBorderOpacityDisplay("mainHeaderBorder");
        updateBorderOpacityDisplay("sectionBorder");

        updateStyle();
      }

      // Hamburger Menu Functions
      window.toggleHamburgerMenu = function () {
        const button = document.querySelector(".hamburger-button");
        const dropdown = document.getElementById("hamburgerDropdown");

        // Check if user is already authenticated
        if (isAuthenticated()) {
          button.classList.toggle("active");
          dropdown.classList.toggle("open");
        } else {
          // Prompt for access code
          promptForAccessCode();
        }
      };

      // Authentication system
      let authenticated = false;
      let ACCESS_CODES = ["admin123", "menu2024", "settings"]; // Fallback codes
      let DYNAMIC_CODE_ENABLED = true;
      let DYNAMIC_CODE_PREFIX = "day";

      // Load access codes from configuration file
      async function loadAccessCodes() {
        try {
          console.log("Loading access codes configuration...");
          const response = await fetch("config/access-codes.json");
          if (response.ok) {
            const config = await response.json();
            ACCESS_CODES = config.accessCodes || ACCESS_CODES;
            DYNAMIC_CODE_ENABLED = config.enableDynamicCode !== false;
            DYNAMIC_CODE_PREFIX = config.dynamicCodePrefix || "day";
            console.log(
              "✅ Access codes loaded from configuration:",
              ACCESS_CODES.length,
              "codes"
            );
          } else {
            console.warn(
              "⚠️ Could not load access codes config (HTTP",
              response.status,
              "), using fallback codes"
            );
            console.log("📋 Fallback codes available:", ACCESS_CODES);
          }
        } catch (error) {
          console.warn("❌ Error loading access codes config:", error.message);
          console.log("📋 Using fallback access codes:", ACCESS_CODES);
        }
      }

      // You can also generate a dynamic daily code
      function generateDynamicCode() {
        if (!DYNAMIC_CODE_ENABLED) return null;
        const today = new Date();
        const dayOfYear = Math.floor(
          (today - new Date(today.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24
        );
        const dynamicCode = `${DYNAMIC_CODE_PREFIX}${dayOfYear}`;
        console.log("🗓️ Today's dynamic code:", dynamicCode);
        return dynamicCode;
      }

      function isAuthenticated() {
        return authenticated;
      }

      function promptForAccessCode() {
        // Show current valid codes in console for debugging (remove in production)
        const dynamicCode = generateDynamicCode();
        const validCodes = [...ACCESS_CODES];
        if (dynamicCode) validCodes.push(dynamicCode);
        console.log("🔑 Valid codes for debugging:", validCodes);

        const code = prompt("Enter access code to unlock menu settings:");
        if (code) {
          console.log("🎯 Entered code:", code);

          // Check both original case and lowercase
          const isValidCode =
            validCodes.includes(code) ||
            validCodes.includes(code.toLowerCase());

          if (isValidCode) {
            console.log("✅ Access granted");
            authenticated = true;
            sessionStorage.setItem("menuAuthenticated", "true");
            updateHamburgerDisplay();
            // Auto-open menu after successful authentication
            toggleHamburgerMenuAuthenticated();
            showAuthenticationFeedback(true);
          } else {
            console.log("❌ Access denied for code:", code);
            console.log("📋 Available codes:", validCodes);
            // Show hint alert for incorrect code
            alert("❌ Incorrect access code.\n\n💡 Hint: Word before gordita");
            showAuthenticationFeedback(false);
          }
        } else {
          console.log("⏹️ User cancelled code entry");
        }
      }

      function toggleHamburgerMenuAuthenticated() {
        const button = document.querySelector(".hamburger-button");
        const dropdown = document.getElementById("hamburgerDropdown");
        button.classList.toggle("active");
        dropdown.classList.toggle("open");
      }

      function showAuthenticationFeedback(success) {
        const button = document.querySelector(".hamburger-button");
        if (success) {
          button.classList.add("success-feedback");
          setTimeout(() => {
            button.classList.remove("success-feedback");
          }, 1000);
        } else {
          button.classList.add("error-feedback");
          setTimeout(() => {
            button.classList.remove("error-feedback");
          }, 500);
        }
      }

      window.updateHamburgerDisplay = function () {
        const dropdown = document.getElementById("hamburgerDropdown");
        const button = document.querySelector(".hamburger-button");

        if (authenticated) {
          // Add authenticated visual state
          button.classList.add("authenticated");
          button.classList.remove("locked");

          // Show full menu options
          dropdown.innerHTML = `
            <button class="hamburger-item" onclick="openSettings()">
              <span class="hamburger-icon">⚙️</span>
              Settings
            </button>
            <button class="hamburger-item" onclick="printMenu()">
              <span class="hamburger-icon">🖨️</span>
              Print Menu
            </button>
            <button class="hamburger-item" onclick="toggleVoiceControls()">
              <span class="hamburger-icon">🔊</span>
              Voice Controls
            </button>
            <button class="hamburger-item" onclick="lockMenu()" style="border-top: 1px solid #e9ecef; margin-top: 4px;">
              <span class="hamburger-icon">🔒</span>
              Lock Menu
            </button>
          `;
        } else {
          // Add locked visual state
          button.classList.remove("authenticated");
          button.classList.add("locked");

          // Hide dropdown content for unauthenticated users
          dropdown.innerHTML = "";
        }
      };

      function lockMenu() {
        authenticated = false;
        sessionStorage.removeItem("menuAuthenticated");

        // Close settings panel if it's open
        const settingsPanel = document.getElementById("settingsPanel");
        if (settingsPanel) {
          settingsPanel.style.display = "none";
        }

        updateHamburgerDisplay();
        closeHamburgerMenu();

        // Visual feedback for locking
        const button = document.querySelector(".hamburger-button");
        button.style.background = "rgba(149, 165, 166, 0.1)";
        setTimeout(() => {
          button.style.background = "";
        }, 800);
      }

      // Check authentication on page load
      window.addEventListener("DOMContentLoaded", function () {
        // Check if user was authenticated in this session
        if (sessionStorage.getItem("menuAuthenticated") === "true") {
          authenticated = true;
        }
        updateHamburgerDisplay();
      });

      window.openSettings = function () {
        if (!authenticated) {
          // If not authenticated, prompt for code again
          promptForAccessCode();
          return;
        }
        toggleSettings();
        // Close hamburger menu
        closeHamburgerMenu();
      };

      window.printMenu = function () {
        if (!authenticated) {
          // If not authenticated, prompt for code again
          promptForAccessCode();
          return;
        }
        window.print();
        // Close hamburger menu
        closeHamburgerMenu();
      };

      window.lockMenu = lockMenu;

      function closeHamburgerMenu() {
        const button = document.querySelector(".hamburger-button");
        const dropdown = document.getElementById("hamburgerDropdown");

        button.classList.remove("active");
        dropdown.classList.remove("open");
      }

      // Close hamburger menu when clicking outside
      document.addEventListener("click", function (event) {
        const hamburgerMenu = document.querySelector(".hamburger-menu");
        if (hamburgerMenu && !hamburgerMenu.contains(event.target)) {
          closeHamburgerMenu();
        }
      });

      // Close hamburger menu on escape key
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          closeHamburgerMenu();
        }
      });

      window.toggleSettings = function () {
        if (!authenticated) {
          // If trying to access settings without authentication, prompt for code
          promptForAccessCode();
          return;
        }
        const panel = document.getElementById("settingsPanel");
        panel.style.display = panel.style.display === "none" ? "block" : "none";
      };

      window.toggleSection = function (sectionId) {
        const content = document.getElementById(sectionId);
        const header = content.previousElementSibling;
        const icon = header.querySelector(".toggle-icon");

        if (content.classList.contains("active")) {
          content.classList.remove("active");
          header.classList.remove("active");
        } else {
          content.classList.add("active");
          header.classList.add("active");
        }
      };

      window.updateBackgroundOptions = function () {
        const type = document.getElementById("backgroundType").value;

        // Show/hide main options
        document.getElementById("colorOption").style.display =
          type === "color" ? "block" : "none";
        document.getElementById("patternOption").style.display =
          type === "pattern" ? "block" : "none";
        document.getElementById("imageOption").style.display =
          type === "image" ? "block" : "none";
        document.getElementById("customImageOption").style.display =
          type === "custom" ? "block" : "none";

        // Show/hide brightness options
        document.getElementById("colorBrightnessOption").style.display =
          type === "color" ? "block" : "none";
        document.getElementById("patternBrightnessOption").style.display =
          type === "pattern" ? "block" : "none";
        document.getElementById("imageBrightnessOption").style.display =
          type === "image" ? "block" : "none";
        document.getElementById("customImageBrightnessOption").style.display =
          type === "custom" ? "block" : "none";

        updateStyle();
      };

      // Global variable to store custom background
      let customBackgroundDataURL = null;

      // Handle custom background upload
      window.handleCustomBackground = function (event) {
        const file = event.target.files[0];
        if (!file) return;

        // Validate file type
        if (!file.type.startsWith("image/")) {
          alert("Please select a valid image file (JPG, PNG, GIF, WebP)");
          return;
        }

        // Check file size (limit to 5MB for performance)
        if (file.size > 5 * 1024 * 1024) {
          alert(
            "Image file is too large. Please choose a file smaller than 5MB."
          );
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          customBackgroundDataURL = e.target.result;
          updateStyle();
          console.log("Custom background loaded successfully");
        };
        reader.onerror = function () {
          alert("Error reading image file. Please try again.");
        };
        reader.readAsDataURL(file);
      };

      // Update opacity display values
      window.updateOpacityDisplay = function (type) {
        const value = document.getElementById(type + "Opacity").value;
        const percentage = Math.round(value / 10);
        let displayText = percentage + "%";

        if (percentage === 0) {
          displayText += " (Invisible)";
        } else if (percentage < 50) {
          displayText += " (Very Faint)";
        } else if (percentage < 100) {
          displayText += " (Translucent)";
        } else if (percentage === 100) {
          displayText += " (Normal)";
        } else if (percentage <= 200) {
          displayText += " (Bright)";
        } else if (percentage <= 500) {
          displayText += " (Very Bright)";
        } else {
          displayText += " (Super Bright)";
        }

        document.getElementById(type + "OpacityValue").textContent =
          displayText;
      };

      // Update brightness display values
      window.updateBrightnessDisplay = function (type) {
        const value = document.getElementById(type + "Brightness").value;
        const percentage = Math.round(value);
        let displayText = percentage + "%";

        if (percentage === 0) {
          displayText += " (Black)";
        } else if (percentage < 50) {
          displayText += " (Very Dark)";
        } else if (percentage < 100) {
          displayText += " (Dimmed)";
        } else if (percentage === 100) {
          displayText += " (Normal)";
        } else if (percentage <= 150) {
          displayText += " (Bright)";
        } else if (percentage <= 200) {
          displayText += " (Very Bright)";
        } else {
          displayText += " (Super Bright)";
        }

        document.getElementById(type + "BrightnessValue").textContent =
          displayText;
      };

      // Update border opacity display values
      window.updateBorderOpacityDisplay = function (type) {
        const value = document.getElementById(type + "Opacity").value;
        const percentage = Math.round(value);
        let displayText = percentage + "%";

        if (percentage === 0) {
          displayText += " (Invisible)";
        } else if (percentage < 25) {
          displayText += " (Very Faint)";
        } else if (percentage < 50) {
          displayText += " (Faint)";
        } else if (percentage < 75) {
          displayText += " (Translucent)";
        } else if (percentage < 100) {
          displayText += " (Semi-Transparent)";
        } else {
          displayText += " (Solid)";
        }

        document.getElementById(type + "OpacityValue").textContent =
          displayText;
      };

      // Get brightness filter CSS
      function getBrightnessFilter(brightnessValue) {
        const brightness = brightnessValue / 100; // Convert to 0-3 scale
        return `brightness(${brightness})`;
      }

      // Convert slider value (0-1000) to CSS opacity and filter values
      function getOpacityAndFilter(sliderValue) {
        const percentage = sliderValue / 10; // Convert to 0-100 scale

        if (percentage <= 100) {
          // Normal range: 0-100% maps to opacity 0-1
          return {
            opacity: percentage / 100,
            filter: "none",
          };
        } else {
          // Extended range: 100-1000% uses full opacity + brightness filter
          const brightness = percentage / 100; // 1.0 to 10.0
          return {
            opacity: 1,
            filter: `brightness(${brightness}) contrast(${Math.min(
              brightness * 0.8,
              3
            )})`,
          };
        }
      }

      window.updateStyle = async function () {
        const fontFamily = document.getElementById("fontFamily").value;
        const mainHeaderFont = document.getElementById("mainHeaderFont").value;
        const sectionHeaderFont =
          document.getElementById("sectionHeaderFont").value;
        const cardFont = document.getElementById("cardFont").value;
        const backgroundType = document.getElementById("backgroundType").value;
        const backgroundColor =
          document.getElementById("backgroundColor").value;
        const backgroundPattern =
          document.getElementById("backgroundPattern").value;
        const backgroundImage =
          document.getElementById("backgroundImage").value;
        const mainHeaderColor =
          document.getElementById("mainHeaderColor").value;
        const mainHeaderBackground = document.getElementById(
          "mainHeaderBackground"
        ).value;
        const mainHeaderSize = document.getElementById("mainHeaderSize").value;
        const dateSize = document.getElementById("dateSize").value;
        const headerColor = document.getElementById("headerColor").value;
        const headerSize = document.getElementById("headerSize").value;
        const cardBackgroundColor = document.getElementById(
          "cardBackgroundColor"
        ).value;
        const cardOpacity = document.getElementById("cardOpacity").value;
        const cardTextColor = document.getElementById("cardTextColor").value;
        const priceColor = document.getElementById("priceColor").value;
        const cardFontWeight = document.getElementById("cardFontWeight").value;
        const cardTitleWeight =
          document.getElementById("cardTitleWeight").value;
        const priceFontWeight =
          document.getElementById("priceFontWeight").value;
        const mainHeaderWeight =
          document.getElementById("mainHeaderWeight").value;
        const sectionHeaderWeight = document.getElementById(
          "sectionHeaderWeight"
        ).value;
        const cardTextSize = document.getElementById("cardTextSize").value;
        const cardTitleSize = document.getElementById("cardTitleSize").value;
        const priceSize = document.getElementById("priceSize").value;

        // Get new opacity values
        const cardFontOpacity =
          document.getElementById("cardFontOpacity").value;
        const mainHeaderOpacity =
          document.getElementById("mainHeaderOpacity").value;
        const sectionHeaderOpacity = document.getElementById(
          "sectionHeaderOpacity"
        ).value;

        // Get background brightness values
        const colorBrightness =
          document.getElementById("colorBrightness").value;
        const patternBrightness =
          document.getElementById("patternBrightness").value;
        const imageBrightness =
          document.getElementById("imageBrightness").value;
        const customImageBrightness = document.getElementById(
          "customImageBrightness"
        ).value;

        // Get border settings
        const cardBorderColor =
          document.getElementById("cardBorderColor").value;
        const cardBorderWidth =
          document.getElementById("cardBorderWidth").value;
        const cardBorderStyle =
          document.getElementById("cardBorderStyle").value;
        const cardBorderOpacity =
          document.getElementById("cardBorderOpacity").value;
        const headerBorderColor =
          document.getElementById("headerBorderColor").value;
        const headerBorderWidth =
          document.getElementById("headerBorderWidth").value;
        const headerBorderOpacity = document.getElementById(
          "headerBorderOpacity"
        ).value;
        const mainHeaderBorderColor = document.getElementById(
          "mainHeaderBorderColor"
        ).value;
        const mainHeaderBorderWidth = document.getElementById(
          "mainHeaderBorderWidth"
        ).value;
        const mainHeaderBorderOpacity = document.getElementById(
          "mainHeaderBorderOpacity"
        ).value;
        const sectionBorderColor =
          document.getElementById("sectionBorderColor").value;
        const sectionBorderWidth =
          document.getElementById("sectionBorderWidth").value;
        const sectionBorderOpacity = document.getElementById(
          "sectionBorderOpacity"
        ).value;

        // Save style settings to database
        const params = new URLSearchParams(window.location.search);
        const menuId = params.get("id");
        if (menuId) {
          try {
            const menu = await getMenu(menuId);
            if (menu) {
              menu.styleSettings = {
                fontFamily,
                backgroundType,
                backgroundColor,
                backgroundPattern,
                backgroundImage,
                mainHeaderFont,
                sectionHeaderFont,
                cardFont,
                mainHeaderColor,
                mainHeaderBackground,
                mainHeaderSize,
                mainHeaderWeight,
                dateSize,
                headerColor,
                headerSize,
                sectionHeaderWeight,
                cardBackgroundColor,
                cardOpacity,
                cardTextColor,
                priceColor,
                cardFontWeight,
                cardTextSize,
                cardTitleSize,
                cardTitleWeight,
                priceSize,
                priceFontWeight,
                cardFontOpacity,
                mainHeaderOpacity,
                sectionHeaderOpacity,
                customBackgroundDataURL,
                colorBrightness,
                patternBrightness,
                imageBrightness,
                customImageBrightness,
                // Add border settings
                cardBorderColor,
                cardBorderWidth,
                cardBorderStyle,
                cardBorderOpacity,
                headerBorderColor,
                headerBorderWidth,
                headerBorderOpacity,
                mainHeaderBorderColor,
                mainHeaderBorderWidth,
                mainHeaderBorderOpacity,
                sectionBorderColor,
                sectionBorderWidth,
                sectionBorderOpacity,
              };
              await saveMenu(menu);
            }
          } catch (error) {
            console.error("Error saving style settings:", error);
          }
        }

        // Update font family
        document.body.style.fontFamily = fontFamily;
        document.querySelector(".menu-header h1").style.fontFamily =
          mainHeaderFont;
        document.querySelectorAll("h2").forEach((header) => {
          header.style.fontFamily = sectionHeaderFont;
        });
        document.querySelectorAll(".menu-card").forEach((card) => {
          card.style.fontFamily = cardFont;
        });

        // Update background based on type
        if (backgroundType === "color") {
          document.body.style.backgroundImage = "none";
          document.body.style.backgroundColor = backgroundColor;
          // Apply color brightness filter
          const colorBrightnessFilter = getBrightnessFilter(colorBrightness);
          document.body.style.filter = colorBrightnessFilter;
          // Remove any overlay for solid colors
          updateBackgroundOverlay("color", {});
        } else {
          // For patterns and images, use overlay system
          document.body.style.backgroundImage = "none";
          document.body.style.backgroundColor = "transparent";
          document.body.style.filter = "none";

          // Create/update background overlay with brightness
          updateBackgroundOverlay(backgroundType, {
            backgroundPattern,
            backgroundImage,
            customBackgroundDataURL,
            patternBrightness,
            imageBrightness,
            customImageBrightness,
          });
        }

        // Update main header
        document.documentElement.style.setProperty(
          "--main-header-color",
          mainHeaderColor
        );
        document.documentElement.style.setProperty(
          "--main-header-background",
          mainHeaderBackground
        );
        document.documentElement.style.setProperty(
          "--main-header-size",
          mainHeaderSize + "px"
        );
        document.documentElement.style.setProperty(
          "--date-size",
          dateSize + "px"
        );
        document.querySelector(".menu-header").style.backgroundColor =
          mainHeaderBackground;
        document.querySelector(".menu-header h1").style.color = mainHeaderColor;
        document.querySelector(".menu-header h1").style.fontSize =
          mainHeaderSize + "px";
        document.querySelector(".menu-header h1").style.fontWeight =
          mainHeaderWeight;
        document.querySelector(".menu-header p").style.color = mainHeaderColor;
        document.querySelector(".menu-header p").style.fontSize =
          dateSize + "px";

        // Apply main header opacity
        const {
          opacity: mainHeaderOpacityOpacity,
          filter: mainHeaderOpacityFilter,
        } = getOpacityAndFilter(mainHeaderOpacity);
        document.querySelector(".menu-header").style.opacity =
          mainHeaderOpacityOpacity;
        document.querySelector(".menu-header").style.filter =
          mainHeaderOpacityFilter;

        // Update section headers
        document.documentElement.style.setProperty(
          "--header-color",
          headerColor
        );
        document.documentElement.style.setProperty(
          "--header-size",
          headerSize + "px"
        );
        document.querySelectorAll("h2").forEach((header) => {
          header.style.color = headerColor;
          header.style.fontSize = headerSize + "px";
          header.style.fontWeight = sectionHeaderWeight;
        });

        // Apply section header opacity
        const {
          opacity: sectionHeaderOpacityOpacity,
          filter: sectionHeaderOpacityFilter,
        } = getOpacityAndFilter(sectionHeaderOpacity);
        document.querySelectorAll("h2").forEach((header) => {
          header.style.opacity = sectionHeaderOpacityOpacity;
          header.style.filter = sectionHeaderOpacityFilter;
        });

        // Update card text
        document.documentElement.style.setProperty(
          "--card-background-color",
          cardBackgroundColor
        );
        document.documentElement.style.setProperty(
          "--card-opacity",
          cardOpacity
        );
        document.documentElement.style.setProperty(
          "--card-text-color",
          cardTextColor
        );
        document.documentElement.style.setProperty("--price-color", priceColor);
        document.documentElement.style.setProperty(
          "--card-text-size",
          cardTextSize + "px"
        );
        document.documentElement.style.setProperty(
          "--card-title-size",
          cardTitleSize + "px"
        );
        document.documentElement.style.setProperty(
          "--price-size",
          priceSize + "px"
        );

        // Update border CSS custom properties with opacity
        function hexToRgba(hex, opacity) {
          const r = parseInt(hex.slice(1, 3), 16);
          const g = parseInt(hex.slice(3, 5), 16);
          const b = parseInt(hex.slice(5, 7), 16);
          return `rgba(${r}, ${g}, ${b}, ${opacity / 100})`;
        }

        // Card borders
        document.documentElement.style.setProperty(
          "--card-border-color",
          hexToRgba(cardBorderColor, cardBorderOpacity)
        );
        document.documentElement.style.setProperty(
          "--card-border-width",
          cardBorderWidth + "px"
        );
        document.documentElement.style.setProperty(
          "--card-border-style",
          cardBorderStyle
        );

        // Section header borders
        document.documentElement.style.setProperty(
          "--header-border-color",
          hexToRgba(headerBorderColor, headerBorderOpacity)
        );
        document.documentElement.style.setProperty(
          "--header-border-width",
          headerBorderWidth + "px"
        );

        // Main header borders
        document.documentElement.style.setProperty(
          "--main-header-border-color",
          hexToRgba(mainHeaderBorderColor, mainHeaderBorderOpacity)
        );
        document.documentElement.style.setProperty(
          "--main-header-border-width",
          mainHeaderBorderWidth + "px"
        );

        // Menu section container borders
        document.documentElement.style.setProperty(
          "--section-border-color",
          hexToRgba(sectionBorderColor, sectionBorderOpacity)
        );
        document.documentElement.style.setProperty(
          "--section-border-width",
          sectionBorderWidth + "px"
        );

        // Apply card background opacity via CSS custom properties (affects ::before pseudo-element)
        const { opacity: cardBackgroundOpacity, filter: cardBackgroundFilter } =
          getOpacityAndFilter(cardOpacity);
        document.documentElement.style.setProperty(
          "--card-bg-opacity",
          cardBackgroundOpacity
        );
        document.documentElement.style.setProperty(
          "--card-bg-filter",
          cardBackgroundFilter
        );

        // Reset card opacity to 1 (so content isn't affected by background opacity)
        document.querySelectorAll(".menu-card").forEach((card) => {
          card.style.opacity = 1;
          card.style.filter = "none";
          card.style.fontWeight = cardFontWeight;
        });

        // Apply separate font opacity to card text elements (independent of background)
        const { opacity: cardFontOpacityValue, filter: cardFontFilter } =
          getOpacityAndFilter(cardFontOpacity);
        document.querySelectorAll(".menu-card h3").forEach((title) => {
          title.style.fontWeight = cardTitleWeight;
          title.style.opacity = cardFontOpacityValue;
          title.style.filter = cardFontFilter;
        });

        document.querySelectorAll(".menu-card .price").forEach((price) => {
          price.style.fontWeight = priceFontWeight;
          price.style.opacity = cardFontOpacityValue;
          price.style.filter = cardFontFilter;
        });

        document.querySelectorAll(".menu-card .ingredients").forEach((text) => {
          text.style.opacity = cardFontOpacityValue;
          text.style.filter = cardFontFilter;
        });

        document.querySelectorAll(".menu-card .description").forEach((text) => {
          text.style.opacity = cardFontOpacityValue;
          text.style.filter = cardFontFilter;
        });

        // Force background on body with all browser prefixes
        const body = document.body;

        // Clear any existing background first
        body.style.removeProperty("background");
        body.style.removeProperty("background-color");
        body.style.removeProperty("background-image");
        body.style.removeProperty("background-size");
        body.style.removeProperty("background-repeat");
        body.style.removeProperty("background-position");

        if (backgroundType === "color") {
          body.style.setProperty(
            "background-color",
            backgroundColor,
            "important"
          );
          body.style.setProperty("background-image", "none", "important");
          // Apply color brightness filter for print
          const colorBrightnessFilter = getBrightnessFilter(colorBrightness);
          body.style.setProperty("filter", colorBrightnessFilter, "important");
          console.log("Set solid color:", backgroundColor);
        } else {
          // For print, apply background directly to body with brightness
          body.style.setProperty(
            "background-color",
            "transparent",
            "important"
          );
          body.style.setProperty("filter", "none", "important");

          if (backgroundType === "pattern") {
            const patternUrl = `url(assets/backgrounds/${backgroundPattern})`;
            body.style.setProperty("background-image", patternUrl, "important");
            body.style.setProperty(
              "background-size",
              "200px 200px",
              "important"
            );
            body.style.setProperty("background-repeat", "repeat", "important");
            body.style.setProperty("background-position", "0 0", "important");
            // Create overlay for print with brightness
            const printOverlay =
              document.querySelector(".background-overlay") ||
              document.createElement("div");
            printOverlay.className = "background-overlay";
            printOverlay.style.backgroundImage = patternUrl;
            printOverlay.style.backgroundSize = "200px 200px";
            printOverlay.style.backgroundRepeat = "repeat";
            printOverlay.style.backgroundPosition = "0 0";
            printOverlay.style.filter = getBrightnessFilter(patternBrightness);
            if (!document.querySelector(".background-overlay")) {
              document.body.appendChild(printOverlay);
            }
            console.log("Set pattern:", patternUrl);
          } else if (backgroundType === "image") {
            const imageUrl = `url(assets/backgrounds/${backgroundImage})`;
            body.style.setProperty("background-image", imageUrl, "important");
            body.style.setProperty("background-size", "cover", "important");
            body.style.setProperty(
              "background-repeat",
              "no-repeat",
              "important"
            );
            body.style.setProperty(
              "background-position",
              "center",
              "important"
            );
            // Create overlay for print with brightness
            const printOverlay =
              document.querySelector(".background-overlay") ||
              document.createElement("div");
            printOverlay.className = "background-overlay";
            printOverlay.style.backgroundImage = imageUrl;
            printOverlay.style.backgroundSize = "cover";
            printOverlay.style.backgroundRepeat = "no-repeat";
            printOverlay.style.backgroundPosition = "center";
            printOverlay.style.filter = getBrightnessFilter(imageBrightness);
            if (!document.querySelector(".background-overlay")) {
              document.body.appendChild(printOverlay);
            }
            console.log("Set image:", imageUrl);
          } else if (backgroundType === "custom" && customBackgroundDataURL) {
            body.style.setProperty(
              "background-image",
              `url(${customBackgroundDataURL})`,
              "important"
            );
            body.style.setProperty("background-size", "cover", "important");
            body.style.setProperty(
              "background-repeat",
              "no-repeat",
              "important"
            );
            body.style.setProperty(
              "background-position",
              "center",
              "important"
            );
            // Create overlay for print with brightness
            const printOverlay =
              document.querySelector(".background-overlay") ||
              document.createElement("div");
            printOverlay.className = "background-overlay";
            printOverlay.style.backgroundImage = `url(${customBackgroundDataURL})`;
            printOverlay.style.backgroundSize = "cover";
            printOverlay.style.backgroundRepeat = "no-repeat";
            printOverlay.style.backgroundPosition = "center";
            printOverlay.style.filter = getBrightnessFilter(
              customImageBrightness
            );
            if (!document.querySelector(".background-overlay")) {
              document.body.appendChild(printOverlay);
            }
            console.log("Set custom background");
          }
        }

        // Force print color adjustment on body
        body.style.setProperty(
          "-webkit-print-color-adjust",
          "exact",
          "important"
        );
        body.style.setProperty("print-color-adjust", "exact", "important");
        body.style.setProperty("color-adjust", "exact", "important");

        // Set body font
        body.style.setProperty("font-family", fontFamily, "important");

        // Also force colors and fonts on all menu elements directly (for print)
        document.querySelectorAll(".menu-card").forEach((card) => {
          // Don't override background - it's handled by pseudo-element
          card.style.setProperty("color", cardTextColor, "important");
          // Don't override opacity - it's handled separately for background vs content
          card.style.setProperty("font-weight", cardFontWeight, "important");
        });

        document.querySelectorAll(".menu-card .price").forEach((price) => {
          price.style.setProperty("color", priceColor, "important");
          price.style.setProperty("font-size", priceSize + "px", "important");
          price.style.setProperty("font-family", cardFont, "important");
          price.style.setProperty("font-weight", priceFontWeight, "important");
        });

        document.querySelectorAll(".menu-card h3").forEach((title) => {
          title.style.setProperty(
            "font-size",
            cardTitleSize + "px",
            "important"
          );
          title.style.setProperty("color", cardTextColor, "important");
          title.style.setProperty("font-family", cardFont, "important");
          title.style.setProperty("font-weight", cardTitleWeight, "important");
        });

        document.querySelectorAll(".menu-card .ingredients").forEach((text) => {
          text.style.setProperty("font-size", cardTextSize + "px", "important");
          text.style.setProperty("color", cardTextColor, "important");
          text.style.setProperty("font-family", cardFont, "important");
          text.style.setProperty("font-weight", cardFontWeight, "important");
        });

        document.querySelectorAll(".menu-card .description").forEach((text) => {
          text.style.setProperty("font-size", cardTextSize + "px", "important");
          text.style.setProperty("color", cardTextColor, "important");
          text.style.setProperty("font-family", cardFont, "important");
          text.style.setProperty("font-weight", cardFontWeight, "important");
        });

        document.querySelectorAll(".menu-header").forEach((header) => {
          header.style.setProperty(
            "background-color",
            mainHeaderBackground,
            "important"
          );
          header.style.setProperty("color", mainHeaderColor, "important");
        });

        document.querySelectorAll(".menu-header h1").forEach((h1) => {
          h1.style.setProperty("color", mainHeaderColor, "important");
          h1.style.setProperty("font-family", mainHeaderFont, "important");
          h1.style.setProperty("font-size", mainHeaderSize + "px", "important");
          h1.style.setProperty("font-weight", mainHeaderWeight, "important");
        });

        document.querySelectorAll(".menu-header p").forEach((p) => {
          p.style.setProperty("color", mainHeaderColor, "important");
          p.style.setProperty("font-size", dateSize + "px", "important");
        });

        document.querySelectorAll("h2").forEach((h2) => {
          h2.style.setProperty("color", headerColor, "important");
          h2.style.setProperty("font-family", sectionHeaderFont, "important");
          h2.style.setProperty("font-size", headerSize + "px", "important");
          h2.style.setProperty("font-weight", sectionHeaderWeight, "important");
        });
      };

      function renderMenu(menu) {
        console.log("Loaded Menu:", menu);
        const container = document.getElementById("menuContainer");

        // Store current menu info for item export
        window.currentMenuInfo = {
          id: menu.id,
          type: menu.type,
          date: menu.date,
        };

        container.innerHTML = `
        <div class="menu-header">
          <h1>${menu.type} Menu</h1>
          <p>${menu.date}</p>
        </div>
        <div class="menu-sections">
          ${renderSection("Appetizers", menu.items.appetizers)}
          ${renderDivider()}
          ${renderSection("Entrées", menu.items.entrees)}
          ${renderDivider()}
          ${renderSection("Desserts", menu.items.desserts)}
        </div>
      `;

        // Apply background
        if (menu.background?.startsWith("#")) {
          document.body.style.backgroundColor = menu.background;
        } else {
          document.body.style.backgroundImage = `url(assets/backgrounds/${menu.background})`;
          document.body.style.backgroundSize = "cover";
          document.body.style.backgroundPosition = "center";
        }
      }

      function renderSection(title, items = []) {
        if (!items || items.length === 0) return "";

        return `
        <h2>${title}</h2>
        <div class="menu-grid">
          ${items
            .map(
              (item, index) => `
            <div class="menu-card">
              <h3>${item.name} - <span class="price">${item.price}</span></h3>
              ${
                item.ingredients
                  ? `<p class="ingredients">${item.ingredients}</p>`
                  : ""
              }
              ${
                item.description
                  ? `<p class="description">${item.description}</p>`
                  : ""
              }
            </div>
          `
            )
            .join("")}
        </div>
      `;
      }

      function renderDivider() {
        return `<div class="divider"></div>`;
      }

      window.addEventListener("beforeprint", function () {
        console.log("Before print triggered"); // Debug log

        const backgroundType = document.getElementById("backgroundType").value;
        const backgroundColor =
          document.getElementById("backgroundColor").value;
        const backgroundPattern =
          document.getElementById("backgroundPattern").value;
        const backgroundImage =
          document.getElementById("backgroundImage").value;
        const cardBackgroundColor = document.getElementById(
          "cardBackgroundColor"
        ).value;
        const priceColor = document.getElementById("priceColor").value;
        const mainHeaderBackground = document.getElementById(
          "mainHeaderBackground"
        ).value;
        const mainHeaderColor =
          document.getElementById("mainHeaderColor").value;
        const headerColor = document.getElementById("headerColor").value;
        const cardTextColor = document.getElementById("cardTextColor").value;

        // Get all font settings
        const fontFamily = document.getElementById("fontFamily").value;
        const mainHeaderFont = document.getElementById("mainHeaderFont").value;
        const sectionHeaderFont =
          document.getElementById("sectionHeaderFont").value;
        const cardFont = document.getElementById("cardFont").value;
        const mainHeaderSize = document.getElementById("mainHeaderSize").value;
        const mainHeaderWeight =
          document.getElementById("mainHeaderWeight").value;
        const dateSize = document.getElementById("dateSize").value;
        const headerSize = document.getElementById("headerSize").value;
        const sectionHeaderWeight = document.getElementById(
          "sectionHeaderWeight"
        ).value;
        const cardOpacity = document.getElementById("cardOpacity").value;
        const cardFontWeight = document.getElementById("cardFontWeight").value;
        const cardTitleWeight =
          document.getElementById("cardTitleWeight").value;
        const priceFontWeight =
          document.getElementById("priceFontWeight").value;
        const cardTextSize = document.getElementById("cardTextSize").value;
        const cardTitleSize = document.getElementById("cardTitleSize").value;
        const priceSize = document.getElementById("priceSize").value;

        // Get brightness settings
        const colorBrightness =
          document.getElementById("colorBrightness").value;
        const patternBrightness =
          document.getElementById("patternBrightness").value;
        const imageBrightness =
          document.getElementById("imageBrightness").value;
        const customImageBrightness = document.getElementById(
          "customImageBrightness"
        ).value;

        console.log("Background type:", backgroundType); // Debug log
        console.log("Background color:", backgroundColor); // Debug log

        // Force all CSS variables on :root
        const root = document.documentElement;
        root.style.setProperty(
          "--card-background-color",
          cardBackgroundColor,
          "important"
        );
        root.style.setProperty("--price-color", priceColor, "important");
        root.style.setProperty(
          "--main-header-background",
          mainHeaderBackground,
          "important"
        );
        root.style.setProperty(
          "--main-header-color",
          mainHeaderColor,
          "important"
        );
        root.style.setProperty("--header-color", headerColor, "important");
        root.style.setProperty("--card-text-color", cardTextColor, "important");

        // Set all font CSS variables
        root.style.setProperty(
          "--main-header-size",
          mainHeaderSize + "px",
          "important"
        );
        root.style.setProperty("--date-size", dateSize + "px", "important");
        root.style.setProperty("--header-size", headerSize + "px", "important");
        root.style.setProperty(
          "--card-text-size",
          cardTextSize + "px",
          "important"
        );
        root.style.setProperty(
          "--card-title-size",
          cardTitleSize + "px",
          "important"
        );
        root.style.setProperty("--price-size", priceSize + "px", "important");

        // Force background on body with all browser prefixes
        const body = document.body;

        // Clear any existing background first
        body.style.removeProperty("background");
        body.style.removeProperty("background-color");
        body.style.removeProperty("background-image");
        body.style.removeProperty("background-size");
        body.style.removeProperty("background-repeat");
        body.style.removeProperty("background-position");

        if (backgroundType === "color") {
          body.style.setProperty(
            "background-color",
            backgroundColor,
            "important"
          );
          body.style.setProperty("background-image", "none", "important");
          console.log("Set solid color:", backgroundColor);
        } else if (backgroundType === "pattern") {
          const patternUrl = `url(assets/backgrounds/${backgroundPattern})`;
          body.style.setProperty("background-image", patternUrl, "important");
          body.style.setProperty("background-size", "200px 200px", "important");
          body.style.setProperty("background-repeat", "repeat", "important");
          body.style.setProperty("background-position", "0 0", "important");
          body.style.setProperty(
            "background-color",
            backgroundColor || cardBackgroundColor,
            "important"
          );
          console.log("Set pattern:", patternUrl);
        } else if (backgroundType === "image") {
          const imageUrl = `url(assets/backgrounds/${backgroundImage})`;
          body.style.setProperty("background-image", imageUrl, "important");
          body.style.setProperty("background-size", "cover", "important");
          body.style.setProperty("background-repeat", "no-repeat", "important");
          body.style.setProperty("background-position", "center", "important");
          body.style.setProperty(
            "background-color",
            backgroundColor || cardBackgroundColor,
            "important"
          );
          console.log("Set image:", imageUrl);
        } else if (backgroundType === "custom" && customBackgroundDataURL) {
          body.style.setProperty(
            "background-image",
            `url(${customBackgroundDataURL})`,
            "important"
          );
          body.style.setProperty("background-size", "cover", "important");
          body.style.setProperty("background-repeat", "no-repeat", "important");
          body.style.setProperty("background-position", "center", "important");
          body.style.setProperty(
            "background-color",
            backgroundColor || cardBackgroundColor,
            "important"
          );
          console.log("Set custom background");
        }

        // Force print color adjustment on body
        body.style.setProperty(
          "-webkit-print-color-adjust",
          "exact",
          "important"
        );
        body.style.setProperty("print-color-adjust", "exact", "important");
        body.style.setProperty("color-adjust", "exact", "important");

        // Set body font
        body.style.setProperty("font-family", fontFamily, "important");

        // Also force colors and fonts on all menu elements directly (for print)
        document.querySelectorAll(".menu-card").forEach((card) => {
          // Don't override background - it's handled by pseudo-element
          card.style.setProperty("color", cardTextColor, "important");
          // Don't override opacity - it's handled separately for background vs content
          card.style.setProperty("font-weight", cardFontWeight, "important");
        });

        document.querySelectorAll(".menu-card h3").forEach((title) => {
          title.style.setProperty(
            "font-size",
            cardTitleSize + "px",
            "important"
          );
          title.style.setProperty("color", cardTextColor, "important");
          title.style.setProperty("font-family", cardFont, "important");
          title.style.setProperty("font-weight", cardTitleWeight, "important");
        });

        document.querySelectorAll(".menu-card .price").forEach((price) => {
          price.style.setProperty("color", priceColor, "important");
          price.style.setProperty("font-size", priceSize + "px", "important");
          price.style.setProperty("font-family", cardFont, "important");
          price.style.setProperty("font-weight", priceFontWeight, "important");
        });

        document.querySelectorAll(".menu-card .ingredients").forEach((text) => {
          text.style.setProperty("font-size", cardTextSize + "px", "important");
          text.style.setProperty("color", cardTextColor, "important");
          text.style.setProperty("font-family", cardFont, "important");
          text.style.setProperty("font-weight", cardFontWeight, "important");
        });

        document.querySelectorAll(".menu-card .description").forEach((text) => {
          text.style.setProperty("font-size", cardTextSize + "px", "important");
          text.style.setProperty("color", cardTextColor, "important");
          text.style.setProperty("font-family", cardFont, "important");
          text.style.setProperty("font-weight", cardFontWeight, "important");
        });

        document.querySelectorAll(".menu-header").forEach((header) => {
          header.style.setProperty(
            "background-color",
            mainHeaderBackground,
            "important"
          );
          header.style.setProperty("color", mainHeaderColor, "important");
        });

        document.querySelectorAll(".menu-header h1").forEach((h1) => {
          h1.style.setProperty("color", mainHeaderColor, "important");
          h1.style.setProperty("font-family", mainHeaderFont, "important");
          h1.style.setProperty("font-size", mainHeaderSize + "px", "important");
          h1.style.setProperty("font-weight", mainHeaderWeight, "important");
        });

        document.querySelectorAll(".menu-header p").forEach((p) => {
          p.style.setProperty("color", mainHeaderColor, "important");
          p.style.setProperty("font-size", dateSize + "px", "important");
        });

        document.querySelectorAll("h2").forEach((h2) => {
          h2.style.setProperty("color", headerColor, "important");
          h2.style.setProperty("font-family", sectionHeaderFont, "important");
          h2.style.setProperty("font-size", headerSize + "px", "important");
          h2.style.setProperty("font-weight", sectionHeaderWeight, "important");
        });
      });
      window.addEventListener("afterprint", function () {
        window.updateStyle();
      });

      // Create or update background overlay
      function updateBackgroundOverlay(backgroundType, settings) {
        // Remove existing overlay
        const existingOverlay = document.querySelector(".background-overlay");
        if (existingOverlay) {
          existingOverlay.remove();
        }

        // Don't create overlay for solid colors (they work fine with body filter)
        if (backgroundType === "color") {
          document.body.classList.remove("has-background-overlay");
          return;
        }

        // Create new overlay for patterns and images
        const overlay = document.createElement("div");
        overlay.className = "background-overlay";

        // Apply background settings to overlay
        if (backgroundType === "pattern") {
          overlay.style.backgroundImage = `url(assets/backgrounds/${settings.backgroundPattern})`;
          overlay.style.backgroundSize = "200px 200px";
          overlay.style.backgroundRepeat = "repeat";
          overlay.style.backgroundPosition = "0 0";
          overlay.style.filter = getBrightnessFilter(
            settings.patternBrightness
          );
        } else if (backgroundType === "image") {
          overlay.style.backgroundImage = `url(assets/backgrounds/${settings.backgroundImage})`;
          overlay.style.backgroundSize = "cover";
          overlay.style.backgroundRepeat = "no-repeat";
          overlay.style.backgroundPosition = "center";
          overlay.style.filter = getBrightnessFilter(settings.imageBrightness);
        } else if (
          backgroundType === "custom" &&
          settings.customBackgroundDataURL
        ) {
          overlay.style.backgroundImage = `url(${settings.customBackgroundDataURL})`;
          overlay.style.backgroundSize = "cover";
          overlay.style.backgroundRepeat = "no-repeat";
          overlay.style.backgroundPosition = "center";
          overlay.style.filter = getBrightnessFilter(
            settings.customImageBrightness
          );
        }

        // Add overlay to document
        document.body.appendChild(overlay);
        document.body.classList.add("has-background-overlay");
      }

      // Voice/Audio System
      let voiceEnabled = false;
      let currentSpeech = null;
      let voices = [];
      let customAudioFiles = new Map(); // For custom recorded audio

      // Initialize Speech Synthesis
      function initVoiceSystem() {
        if ("speechSynthesis" in window) {
          // Load available voices
          function loadVoices() {
            voices = speechSynthesis.getVoices();
            populateVoiceSelect();
          }

          loadVoices();
          speechSynthesis.onvoiceschanged = loadVoices;

          // Setup voice controls
          setupVoiceControls();

          console.log("🔊 Voice system initialized");
        } else {
          console.warn("⚠️ Speech synthesis not supported in this browser");
        }
      }

      function populateVoiceSelect() {
        const voiceSelect = document.getElementById("voiceSelect");
        voiceSelect.innerHTML = "";

        voices.forEach((voice, index) => {
          const option = document.createElement("option");
          option.value = index;
          option.textContent = `${voice.name} (${voice.lang})`;
          if (voice.default) option.selected = true;
          voiceSelect.appendChild(option);
        });
      }

      function setupVoiceControls() {
        const rateSlider = document.getElementById("speechRate");
        const pitchSlider = document.getElementById("speechPitch");
        const rateDisplay = document.getElementById("rateDisplay");
        const pitchDisplay = document.getElementById("pitchDisplay");

        rateSlider.addEventListener("input", (e) => {
          rateDisplay.textContent = parseFloat(e.target.value).toFixed(1) + "x";
        });

        pitchSlider.addEventListener("input", (e) => {
          pitchDisplay.textContent = parseFloat(e.target.value).toFixed(1);
        });
      }

      window.toggleVoiceMode = function () {
        if (!authenticated) {
          promptForAccessCode();
          return;
        }

        voiceEnabled = !voiceEnabled;
        const toggleButton = document.getElementById("voiceToggle");
        const voiceControls = document.getElementById("voiceControls");

        if (voiceEnabled) {
          toggleButton.textContent = "Disable Voice";
          toggleButton.classList.remove("disabled");
          enableAudioInteractions();
          console.log("🔊 Voice mode enabled");
        } else {
          toggleButton.textContent = "Enable Voice";
          toggleButton.classList.add("disabled");
          disableAudioInteractions();
          stopSpeaking();
          console.log("🔇 Voice mode disabled");
        }

        closeHamburgerMenu();
      };

      window.toggleVoiceControls = function () {
        if (!authenticated) {
          promptForAccessCode();
          return;
        }

        const voiceControls = document.getElementById("voiceControls");
        voiceControls.classList.toggle("show");
        closeHamburgerMenu();
      };

      function enableAudioInteractions() {
        // Add click listeners and visual indicators to menu items
        document.querySelectorAll(".menu-card").forEach((card) => {
          card.classList.add("audio-enabled");
          card.addEventListener("click", handleCardClick);

          // Add audio icon
          if (!card.querySelector(".audio-icon")) {
            const audioIcon = document.createElement("div");
            audioIcon.className = "audio-icon";
            audioIcon.innerHTML = "🔊";
            card.appendChild(audioIcon);
          }
        });

        // Add click listeners to headers
        document.querySelectorAll("h2").forEach((header) => {
          header.classList.add("audio-enabled");
          header.addEventListener("click", handleHeaderClick);

          // Add audio icon
          if (!header.querySelector(".audio-icon")) {
            const audioIcon = document.createElement("div");
            audioIcon.className = "audio-icon";
            audioIcon.innerHTML = "🔊";
            header.appendChild(audioIcon);
          }
        });

        // Add click listener to main header
        const mainHeader = document.querySelector(".menu-header");
        if (mainHeader) {
          mainHeader.classList.add("audio-enabled");
          mainHeader.addEventListener("click", handleMainHeaderClick);

          if (!mainHeader.querySelector(".audio-icon")) {
            const audioIcon = document.createElement("div");
            audioIcon.className = "audio-icon";
            audioIcon.innerHTML = "🔊";
            mainHeader.appendChild(audioIcon);
          }
        }
      }

      function disableAudioInteractions() {
        document.querySelectorAll(".audio-enabled").forEach((element) => {
          element.classList.remove("audio-enabled", "speaking");
          element.removeEventListener("click", handleCardClick);
          element.removeEventListener("click", handleHeaderClick);
          element.removeEventListener("click", handleMainHeaderClick);

          const audioIcon = element.querySelector(".audio-icon");
          if (audioIcon) audioIcon.remove();
        });
      }

      function handleCardClick(event) {
        if (!voiceEnabled) return;

        event.preventDefault();
        const card = event.currentTarget;

        // Extract text content
        const title = card.querySelector("h3").textContent;
        const ingredients =
          card.querySelector(".ingredients")?.textContent || "";
        const description =
          card.querySelector(".description")?.textContent || "";

        let textToSpeak = title;
        if (ingredients) textToSpeak += ". Ingredients: " + ingredients;
        if (description) textToSpeak += ". " + description;

        speakText(textToSpeak, card);
      }

      function handleHeaderClick(event) {
        if (!voiceEnabled) return;

        event.preventDefault();
        const header = event.currentTarget;
        const textToSpeak = "Menu section: " + header.textContent;

        speakText(textToSpeak, header);
      }

      function handleMainHeaderClick(event) {
        if (!voiceEnabled) return;

        event.preventDefault();
        const header = event.currentTarget;
        const title = header.querySelector("h1").textContent;
        const date = header.querySelector("p").textContent;
        const textToSpeak = title + " for " + date;

        speakText(textToSpeak, header);
      }

      function speakText(text, element) {
        // Stop any current speech
        stopSpeaking();

        // Check for custom audio first
        const customAudio = getCustomAudio(text);
        if (customAudio) {
          playCustomAudio(customAudio, element);
          return;
        }

        // Use Web Speech API
        if ("speechSynthesis" in window) {
          currentSpeech = new SpeechSynthesisUtterance(text);

          // Get current settings
          const voiceSelect = document.getElementById("voiceSelect");
          const rateSlider = document.getElementById("speechRate");
          const pitchSlider = document.getElementById("speechPitch");

          if (voices[voiceSelect.value]) {
            currentSpeech.voice = voices[voiceSelect.value];
          }
          currentSpeech.rate = parseFloat(rateSlider.value);
          currentSpeech.pitch = parseFloat(pitchSlider.value);

          // Visual feedback
          element.classList.add("speaking");

          currentSpeech.onend = () => {
            element.classList.remove("speaking");
            currentSpeech = null;
          };

          currentSpeech.onerror = (event) => {
            console.error("Speech synthesis error:", event.error);
            element.classList.remove("speaking");
            currentSpeech = null;
          };

          speechSynthesis.speak(currentSpeech);
          console.log("🔊 Speaking:", text.substring(0, 50) + "...");
        }
      }

      function stopSpeaking() {
        if (currentSpeech) {
          speechSynthesis.cancel();
          currentSpeech = null;
        }

        // Remove visual feedback from all elements
        document.querySelectorAll(".speaking").forEach((el) => {
          el.classList.remove("speaking");
        });
      }

      window.testVoice = function () {
        if (!voiceEnabled) {
          alert("Please enable voice mode first");
          return;
        }

        const testText =
          "Hello! This is a test of the voice system. The menu reading feature is working correctly.";
        const dummyElement = document.createElement("div");
        speakText(testText, dummyElement);
      };

      // Custom Audio System (for user's recorded audio files)
      function getCustomAudio(text) {
        // Check if custom audio exists for this text
        return customAudioFiles.get(text.toLowerCase().trim());
      }

      function playCustomAudio(audioUrl, element) {
        const audio = new Audio(audioUrl);

        element.classList.add("speaking");

        audio.onended = () => {
          element.classList.remove("speaking");
        };

        audio.onerror = () => {
          console.warn("Custom audio failed, falling back to speech synthesis");
          element.classList.remove("speaking");
          // Fallback to speech synthesis
          speakText(text, element);
        };

        audio.play();
      }

      // Function to load custom audio mappings
      window.loadCustomAudio = async function () {
        try {
          const response = await fetch("audio/menu-audio-mappings.json");
          if (response.ok) {
            const mappings = await response.json();
            Object.entries(mappings).forEach(([text, audioFile]) => {
              customAudioFiles.set(
                text.toLowerCase().trim(),
                `audio/${audioFile}`
              );
            });
            console.log(
              "🎵 Custom audio mappings loaded:",
              customAudioFiles.size,
              "files"
            );
          }
        } catch (error) {
          console.log("ℹ️ No custom audio mappings found (this is optional)");
        }
      };
    </script>
  </body>
</html>
